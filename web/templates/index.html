  
{% extends "base.html" %}
{% block content %}

<!-- UPPER CLUSTER OF 3: Inventory / Cash register / New data record -->
<div class="row g-3 mb-3">
  <!-- Inventory -->
  <div class="col-6 col-md-4">
    <div class="card shadow-sm h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span>{{ _('Inventory:') }}</span>
        <span class="badge bg-primary">
          {{ inv_current }} {{ _('Btl.') }}
          {% if delta_inv and (from or to) %}
            <small class="text-muted">(Δ {{ delta_inv }} during period)</small>
          {% endif %}
        </span>
      </div>
      <div class="card-body sparkline-container">
        <div class="ratio sparkline-ratio">
          <canvas id="sparklineInv"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Cash balance -->
  <div class="col-6 col-md-4">
    <div class="card shadow-sm h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span>{{ _('Cash register:') }}</span>
        <span class="badge bg-success">
          {{ format_eur_de(kas_current) }}
          {% if delta_cashbalance and (from or to) %}
            <small class="text-muted">(Δ {{ format_eur_de(delta_cashbalance) }} in period)</small>
          {% endif %}
        </span>
      </div>
      <div class="card-body sparkline-container">
        <div class="ratio sparkline-ratio">
          <canvas id="sparklineKas"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Form for new record -->
  {% if can_add %}
  <div class="col-12 col-md-4">
    <div class="card shadow-sm h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span>{{ _('Add new record') }}</span>
        <button class="btn btn-sm btn-outline-secondary d-md-none"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#collapseNewEntry"
                aria-expanded="false"
                aria-controls="collapseNewEntry">
          <i class="bi-chevron-down"></i>
        </button>
      </div>
      <div id="collapseNewEntry" class="collapse show">
        <div class="card-body">
          <!-- Formular -->
          <form method="post" action="{{ url_for('bbalance_routes.add') }}" id="transaction-form" novalidate>
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <!-- Date -->
            <div class="input-group mb-3 w-100">
              <span class="input-group-text"><i class="bi bi-calendar"></i></span>
              <div class="form-floating flex-grow-1">
                <input type="text" name="date" class="form-control" placeholder="Date" id="date" value="{{ default_date }}" required autofocus>
                <label for="date">{{ _('Date') }}</label>
              </div>
            </div>
            <!-- Full bottles -->
            <div class="input-group mb-3 w-100">
              <span class="input-group-text"><i class="bi bi-cup-straw"></i></span>
              <div class="form-floating flex-grow-1">
                <input name="full" type="number" class="form-control" placeholder="0" id="full">
                <label for="full">{{ _('Full bottles') }}</label>
              </div>
            </div>
            <!-- Empty bottles -->
            <div class="input-group mb-3 w-100">
              <span class="input-group-text"><i class="bi bi-cup-straw"></i></span>
              <div class="form-floating flex-grow-1">
                <input name="empty" type="number" class="form-control" placeholder="0" id="empty">
                <label for="empty">{{ _('Empty') }}</label>
              </div>
            </div>
            <!-- Revenue -->
            <div class="input-group mb-3 w-100">
              <span class="input-group-text"><i class="bi bi-plus-circle"></i></span>
              <div class="form-floating flex-grow-1">
                <input name="revenue" type="number" step="0.01" class="form-control" placeholder="0.00" id="revenue">
                <label for="revenue">{{ _('Revenue') }}</label>
              </div>
            </div>
            <!-- Expense -->
            <div class="input-group mb-3 w-100">
              <span class="input-group-text"><i class="bi bi-dash-circle"></i></span>
              <div class="form-floating flex-grow-1">
                <input name="expense" type="number" step="0.01" class="form-control" placeholder="0.00" id="expense">
                <label for="expense">{{ _('Expense') }}</label>
              </div>
            </div>
            <!-- Note -->
            <div class="input-group mb-3 w-100">
              <span class="input-group-text"><i class="bi bi-chat-text"></i></span>
              <div class="form-floating flex-grow-1">
                <select id="note" name="note" class="form-select">
                  {% for option in notes %}
                    <option value="{{ option }}">{{ option }}</option>
                  {% endfor %}
                </select>
                <label for="note">{{ _('Note') }}</label>
              </div>
            </div>
            <!-- Buttons -->
            <div class="d-flex gap-2 w-100">
              <button type="submit" class="btn btn-success flex-grow-1" disabled>
                <i class="bi-plus-lg me-1"></i> {{ _('Add') }}
              </button>
              <button type="button" class="btn btn-outline-primary position-relative" data-bs-toggle="modal"
                data-bs-target="#uploadModal" id="uploadBtn">
                <i class="bi-upload me-1"></i> {{ _('Upload') }}
                <span id="uploadBadge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-secondary d-none">0</span>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
</div>


<!-- FILTER -->
<div class="row g-3 mb-3">
  <div class="col-12">
    <div class="card shadow-sm h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span>{{ _('Filter') }}</span>
        <span id="filterBadge" class="badge bg-primary ms-2 d-none">{{ _('Active') }}</span>
        <button class="btn btn-sm btn-outline-secondary d-md-none" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFilters">
          <i class="bi-chevron-down"></i>
        </button>
      </div>
      <div id="collapseFilters" class="collapse show">
        <div class="card-body">

            <form method="get"
                  class="row row-cols-1 row-cols-md-auto row-cols-lg-auto g-2 align-items-end form-compact"
                  id="filtersForm"
                  aria-label="{{ _('Filter for entries') }}">

              <!-- Suche -->
              <div class="col">
                <label for="filter_q" class="form-label mb-1">{{ _('Search') }}</label>
                <div class="input-group">
                  <span class="input-group-text"><i class="bi-search"></i></span>
                  <input type="text"
                        id="filter_q"
                        name="q"
                        class="form-control"
                        placeholder="{{ _('Date/Note') }}"
                        value="{{ request.args.get('q','') }}"
                        autocomplete="off">
                </div>
              </div>

              <!-- Timestamp -->
              <div class="col">
                <label for="filter_daterange" class="form-label mb-1">{{ _('Timestamp') }}</label>
                <div class="input-group">
                  <span class="input-group-text"><i class="bi-calendar"></i></span>
                  <input type="text"
                        id="filter_daterange"
                        name="daterange"
                        class="form-control"
                        placeholder="{{ _('TT.MM.JJJJ – TT.MM.JJJJ') }}"
                        value="{{ request.args.get('daterange','') }}"
                        autocomplete="off">
                  <input type="hidden" id="filter_from" name="from" value="{{ request.args.get('from','') }}">
                  <input type="hidden" id="filter_to" name="to" value="{{ request.args.get('to','') }}">
                </div>
              </div>

               <!-- Year -->
              <div class="col">
                <label for="filter_year" class="form-label mb-1">{{ _('Year') }}</label>
                <div class="input-group">
                  <span class="input-group-text"><i class="bi-calendar"></i></span>
                  <select id="filter_year" name="year" class="form-select" onchange="this.form.submit()">
                    <option value="all" {{ 'selected' if selected_year == 'all' else '' }}>{{ _('All') }}</option>
                    {% for y in years %}
                      <option value="{{ y }}" {{ 'selected' if selected_year == y|string else '' }}>{{ y }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>

              <!-- Attachments -->
              <div class="col">
                <label for="filter_attachments" class="form-label mb-1">{{ _('Attachments') }}</label>
                <div class="input-group">
                  <span class="input-group-text"><i class="bi-paperclip"></i></span>
                  <select id="filter_attachments" name="attachments" class="form-select">
                    <option value="" {{ '' if request.args.get('attachments') else 'selected' }}>{{ _('All') }}</option>
                    <option value="only" {{ 'selected' if request.args.get('attachments')=='only' else '' }}>{{ _('With attachment') }}</option>
                    <option value="none" {{ 'selected' if request.args.get('attachments')=='none' else '' }}>{{ _('Without attachment') }}</option>
                  </select>
                </div>
              </div>

              <!-- Actions: Reset + Export/Import -->
              <div class="col d-flex flex-wrap gap-2 ms-auto justify-content-end">
                <a class="btn btn-outline-secondary" href="{{ url_for('bbalance_routes.index') }}">
                  <i class="bi bi-eraser me-1"></i>{{ _('Reset filter') }}
                </a>

                <div class="btn-group">
                  {% if can_export_pdf %}
                  <a class="btn btn-outline-danger"
                    href="{{ url_for('export_pdf') }}?{{ request.query_string.decode() if request.query_string else '' }}"
                    title="{{ _('PDF export') }}">
                    <i class="bi-file-earmark-pdf me-1 text-danger"></i>{{ _('PDF export') }}
                  </a>
                  {% endif %}

                  {% if can_export_csv or can_import_csv %}
                    <button type="button" class="btn btn-outline-danger dropdown-toggle dropdown-toggle-split"
                            data-bs-toggle="dropdown" aria-expanded="false"
                            aria-label="{{ _('Additional export options') }}">
                      <span class="visually-hidden">{{ _('Additional export options') }}</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                    {% if can_export_csv %}
                      <li>
                        <a class="dropdown-item"
                          href="{{ url_for('bbalance_routes.export_csv') }}?{{ request.query_string.decode() if request.query_string else '' }}">
                          <i class="bi-filetype-csv me-2 text-success"></i> {{ _('CSV export') }}
                        </a>
                      </li>
                    {% endif %}

                    <!-- CSV import -->
                    {% if can_import_csv %}
                      <li>
                        <a class="dropdown-item"
                          href="#"
                          data-bs-toggle="modal"
                          data-bs-target="#csvImportModal">
                          <i class="bi-filetype-csv me-2 text-info"></i> {{ _('CSV import') }}
                        </a>
                      </li>
                    {% endif %}
                    </ul>
                  {% endif %}
                </div>
              </div>
            </form>
          </div>
        </div>
    </div>
  </div>
</div>


<!-- Entries -->
<div class="row g-3 mb-3">
  <div class="col-12">
    <div class="card shadow-sm h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span>{{ _('Entries') }}</span>
      </div>
      <div class="card-body">
        <div class="table-responsive w-100">
          <table class="table table-sm table-striped table-hover align-middle table-stacked">
            <thead class="table-light">
              <tr>
                <th class="text-center">{{ _('Date') }}</th>
                <th class="text-center">{{ _('Inventory change') }}</th>
                <th class="text-center">{{ _('Inventory') }}</th>
                <th class="text-center">{{ _('Payment') }}</th>
                <th class="text-center">{{ _('Cash balance') }}</th>
                <th class="text-center">{{ _('Note') }}</th>
                <th class="text-center">{{ _('Actions') }}</th>
              </tr>
            </thead>
            <tbody>
              {% for e in entries %}
                {% set changed = (e.full != 0 or e.empty != 0 or e.revenue != 0 or e.expense != 0) %}
                <tr
                  data-changed="{{ 1 if changed else 0 }}"
                  data-full="{{ 1 if e.full != 0 else 0 }}"
                  data-empty="{{ 1 if e.empty != 0 else 0 }}"
                  data-revenue="{{ 1 if e.revenue != 0 else 0 }}"
                  data-expense="{{ 1 if e.expense != 0 else 0 }}"
                  data-full-val="{{ e.full or 0 }}"
                  data-empty-val="{{ e.empty or 0 }}"
                  data-revenue-val="{{ e.revenue or 0 }}"
                  data-expense-val="{{ e.expense or 0 }}"
                >
                  
                <td class="text-end" data-label="{{ _('Date') }}" data-col="date"
                    data-sort="{{ e.date.isoformat() if e.date else '' }}">
                  <span class="badge-compact badge-date badge-soft">
                    {{ format_date_de(e.date) }}
                  </span>
                </td>


                  {# --- New: stock change (full/empty) --- #}
                  <td class="text-end" data-label="{{ _('Inventory change') }}" data-col="delta-inv">
                    <span class="d-inline-flex flex-nowrap gap-1">
                      {% if e.full != 0 %}
                        <span class="badge delta delta-pos" title="{{ _('Full bottles') }}">
                          +{{ e.full }} {{ _('Btl.') }}
                          <span class="visually-hidden">{{ _('Full bottles') }}</span>
                        </span>
                      {% endif %}
                      {% if e.empty != 0 %}
                        <span class="badge delta delta-neg" title="{{ _('Empty') }}">
                          −{{ e.empty }} {{ _('Btl.') }}
                          <span class="visually-hidden">{{ _('Empty') }}</span>
                        </span>
                      {% endif %}
                      {% if e.full == 0 and e.empty == 0 %}
                        <span class="text-muted">—</span>
                      {% endif %}
                    </span>
                  </td>

                  <td class="text-end" data-label="{{ _('Inventory') }}" data-col="inventory">
                    <span class="badge badge-compact badge-inventory badge-soft">
                      {{ e.inventory }} {{ _('Btl.') }}
                      <span class="dir-arrow" aria-hidden="true"></span>
                    </span>
                  </td>

                  {# --- NEW: Payment (Revenue/Expense) --- #}
                  <td class="text-end" data-label="{{ _('Payment') }}" data-col="delta-kasse">
                    <span class="d-inline-flex flex-nowrap gap-1">
                      {% if e.revenue != 0 %}
                        <span class="badge delta delta-pos" title="{{ _('Revenue') }}">
                          +{{ format_eur_de(e.revenue) }}
                          <span class="visually-hidden">{{ _('Revenue') }}</span>
                        </span>
                      {% endif %}
                      {% if e.expense != 0 %}
                        <span class="badge delta delta-neg" title="{{ _('Expense') }}">
                          −{{ format_eur_de(e.expense) }}
                          <span class="visually-hidden">{{ _('Expense') }}</span>
                        </span>
                      {% endif %}
                      {% if e.revenue == 0 and e.expense == 0 %}
                        <span class="text-muted">—</span>
                      {% endif %}
                    </span>
                  </td>

                  <td class="text-end" data-label="{{ _('Cash balance') }}" data-col="cashBalance">
                    <span class="badge badge-compact badge-kasse badge-soft">
                      {{ format_eur_de(e.cashBalance) }}
                      <span class="dir-arrow" aria-hidden="true"></span>
                    </span>
                  </td>

                  <td class="text-start" data-label="{{ _('Note') }}" data-col="note"
                      data-sort="{{ (e.note or '').lower() }}">
                    {% if e.note %}
                      <span class="badge-compact badge-note badge-soft" title="{{ e.note }}">
                        {{ e.note }}
                      </span>
                    {% else %}
                      <span class="text-muted">—</span>
                    {% endif %}
                  </td>

                  {# Actions unchanged #}
                    <td class="text-start" data-label="{{ _('Actions') }}" data-col="actions">
                      {% set role = current_user().get('role') %}
                      {% if role in ['Editor', 'Manager', 'Admin'] %}
                      <a class="btn btn-sm btn-outline-primary"
                        href="{{ url_for('bbalance_routes.edit', entry_id=e.id) }}"
                        title="{{ _('Edit') }}">
                        <i class="bi-pencil-square"></i>
                      </a>
                      {% endif %}

                      <button class="btn btn-sm btn-outline-secondary position-relative"
                              type="button"
                              onclick="openAttachments({{ e.id }})"
                              title="{{ _('Open documents') }}">
                        <i class="bi-paperclip"></i>
                        {% if e.attachment_count and e.attachment_count > 0 %}
                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-secondary">
                          {{ e.attachment_count }}
                        </span>
                        {% endif %}
                      </button>

                      {% if role in ['Editor', 'Manager', 'Admin'] %}
                      <form method="post"
                            action="{{ url_for('bbalance_routes.delete', entry_id=e.id) }}"
                            class="d-inline"
                            onsubmit="return confirm('{{ _('Delete entry permanently?') }}');">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button class="btn btn-sm btn-outline-danger" title="{{ _('Delete') }}">
                          <i class="bi-trash"></i>
                        </button>
                      </form>
                      {% endif %}
                  </td>
                </tr>
              {% else %}
                <tr>
                  <td colspan="7" class="text-center text-muted">{{ _('No entries available.') }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

  <!-- CSV Import Modal -->
  <div class="modal fade" id="csvImportModal" tabindex="-1" aria-labelledby="csvImportModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <form action="{{ url_for('import_preview') if IMPORT_USE_PREVIEW else url_for('bbalance_routes.import_csv') }}" method="post" enctype="multipart/form-data">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

          <!-- Header -->
          <div class="modal-header">
            <h5 class="modal-title" id="csvImportModalLabel">{{ _('CSV file import') }}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Close') }}"></button>
          </div>

          <!-- Body -->
          <div class="modal-body">
            <!-- File upload -->
            <div class="input-group  mb-3">
              <span class="input-group-text"><i class="bi bi-file-earmark-spreadsheet"></i></span>
              <div class="form-floating flex-grow-1">
                <input id="csvFile" name="file" type="file" accept=".csv,text/csv" required class="form-control"
                placeholder="CSV-Datei auswählen">
                <label for="csvFile" class="form-label">{{ _('Select CSV file') }}</label>
              </div>
              <small class="form-text text-muted">
                {{ _("Expected headers:") }}
                <code>Date;Full;Empty;Inventory;Revenue;Expense;Cash balance;Note</code>
                {{ _("or short form without Inventory/Cash balance.") }}
              </small>
            </div>
            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" name="replace_all" id="replaceAll">
              <label class="form-check-label" for="replaceAll">
                {{ _('Completely replace existing entries') }}
              </label>
            </div>
          </div>
          <div class="modal-footer d-flex justify-content-between">
            <a href="{{ url_for('import_sample') }}" class="btn btn-link">
              <i class="bi bi-download me-1"></i> {{ _('Download sample CSV file') }}
            </a>
            <button type="submit" class="btn btn-primary">
              <i class="bi bi-eye me-1"></i> {{ _('Show preview') }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Attachments Modal -->
  <div class="modal fade" id="attachmentsModal" tabindex="-1" aria-labelledby="attachmentsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-md">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="attachmentsModalLabel">{{ _('Attachments') }}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Close') }}"></button>
        </div>
        <div class="modal-body">
          <ul id="attachmentsList" class="list-group"></ul>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Close') }}</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Upload-Modal -->
  <input type="hidden" id="temp_token" value="{{ temp_token }}">
  <div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="uploadModalLabel">{{ _('Upload attachments') }}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Close') }}"></button>
        </div>

        <div class="modal-body">
          <div class="input-group mb-2">
            <input class="form-control" type="file" id="add_temp_files" multiple
              accept=".pdf,.png,.jpg,.jpeg,.gif,.webp,.heic,.heif,.svg,.txt,.csv,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.xml,.json">
            <button class="btn btn-outline-primary" type="button" id="btnTempUpload">
              <i class="bi-upload me-1"></i> {{ _('Upload') }}
            </button>
          </div>
          <div class="form-text">
            {{ _('Acceptable formats:') }} PDF, images, Office, text. {{ _('Multiple files possible.') }}
          </div>

          <ul id="addTempAttachmentsList" class="list-group mt-3"></ul>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Close') }}</button>
        </div>
      </div>
    </div>
  </div>
  <div class="toast-container position-fixed top-0 end-0 p-3" id="bbToastContainer"></div>


  {% endblock %}

  {% block scripts %}
  <!-- Add new record - closed -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const el = document.getElementById('collapseNewEntry');
      if (el && window.matchMedia('(max-width: 767.98px)').matches) {
        const c = new bootstrap.Collapse(el, { toggle: false });
        c.hide();
      }
  });
  </script>

    <!-- Filter - closed-->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const el = document.getElementById('collapseFilters');
      if (el && window.matchMedia('(max-width: 767.98px)').matches) {
        const c = new bootstrap.Collapse(el, { toggle: false });
        c.hide();
      }
  });
  </script>

  <!-- Plugin for dashed zero line -->
  <script>
    // Simple dashed zero line for Y=0
    const zeroLinePlugin = {
      id: 'zeroLinePlugin',
      afterDatasetsDraw(chart, args, pluginOptions) {
        const { ctx, chartArea, scales } = chart;
        const yScale = scales?.y;
        if (!yScale) return;

        // Calculate pixel position of the zero line
        const yZero = yScale.getPixelForValue(0);

        // Only draw if 0 is in the visible range
        if (yZero < chartArea.top || yZero > chartArea.bottom) return;

        ctx.save();
        ctx.beginPath();
        ctx.setLineDash([6, 4]);            // dashed
        ctx.lineWidth = 1.5;
        ctx.strokeStyle = (getComputedStyle(document.documentElement)
          .getPropertyValue('--bs-secondary') || '#6c757d').trim();
        ctx.moveTo(chartArea.left, yZero);
        ctx.lineTo(chartArea.right, yZero);
        ctx.stroke();
        ctx.restore();
      }
    };

    // register globally
    if (window.Chart) Chart.register(zeroLinePlugin);
  </script>

  <script>
    // Data from Flask (Jinja only renders the values))
    const labelsRaw = {{ labels_all | tojson | safe }};
    const dataInv   = {{ series_inv | tojson | safe }};
    const dataCashbalance   = {{ series_cashbalance | tojson | safe }};

    // Optional: ISO currency from context (fallback EUR)
    const CURRENCY_CODE = "{{ currency_code | default('EUR') }}";

    // Labels stable against UTC shift: Interpret date as local midnight
    const labels = (Array.isArray(labelsRaw) ? labelsRaw : []).map(d => {
        if (!d) return '';                          // empty -> no date
        const parsed = new Date(`${d}T00:00:00`);   // local midnight
        return isNaN(parsed) ? '' : parsed.toLocaleDateString('de-DE');
    });


    // Bootstrap colors from CSS variables
    const css = getComputedStyle(document.documentElement);
    const colorPrimary = (css.getPropertyValue('--bs-primary') || '#0d6efd').trim();
    const colorSuccess = (css.getPropertyValue('--bs-success') || '#198754').trim();
    const gridColor    = (css.getPropertyValue('--bs-border-color') || '#dee2e6').trim();

    // Common chart options for both sparklines
    const baseOptions = {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { intersect: false, mode: 'index' },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            title: (items) => items[0]?.label ?? '',
            label: (ctx) => {
              const val = ctx.parsed?.y ?? 0;
              const n = Number(val);
              const safe = Number.isFinite(n) ? n.toFixed(2) : '0.00';

              if (ctx.dataset?.label === 'Cash balance') {
                // Simpler: Value + symbol from Jinja
                return `${safe} {{ _('currency') }}`;
              }
              return `${val} {{ _('Btl.') }}`;
            }
          }
        }

      },
      scales: {
        x: {
          display: true,                   // visible
          grid: { display: false },
          ticks: {
            maxTicksLimit: 6,              // compact
            autoSkip: true
          }
        },
        y: {
          display: true,                   // visible
          grid: {
            color: gridColor,
            lineWidth: 1
          },
          ticks: {
            maxTicksLimit: 5,              // compact
          }
        }
      }
    };


    // Gentle surface filling
    function makeGradient(ctx, baseColor) {
      const h = ctx?.canvas?.height || 80;
      const g = ctx.createLinearGradient(0, 0, 0, h);
      g.addColorStop(0, baseColor + '33'); // ~20% opacity
      g.addColorStop(1, baseColor + '00'); // 0% opacity
      return g;
    }

    // Inventory-Sparkline
    (function renderInv() {
      const invCanvas = document.getElementById('sparklineInv');
      if (!invCanvas || !window.Chart) return;
      const invCtx = invCanvas.getContext('2d');
      new Chart(invCtx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'Inventory',
            data: dataInv || [],
            borderColor: colorPrimary,
            backgroundColor: makeGradient(invCtx, colorPrimary),
            borderWidth: 2,
            fill: true,
            tension: 0.35,
            pointRadius: 3,
            pointBackgroundColor: colorPrimary
          }]
        },
        options: baseOptions
      });
    })();

    // Cash balance-Sparkline
    (function renderKas() {
      const kasCanvas = document.getElementById('sparklineKas');
      if (!kasCanvas || !window.Chart) return;
      const kasCtx = kasCanvas.getContext('2d');
      new Chart(kasCtx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'Cash balance',
            data: dataCashbalance || [],
            borderColor: colorSuccess,
            backgroundColor: makeGradient(kasCtx, colorSuccess),
            borderWidth: 2,
            fill: true,
            tension: 0.35,
            pointRadius: 3,
            pointBackgroundColor: colorSuccess
          }]
        },
        options: baseOptions
      });
    })();
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('transaction-form');
      const orderIds = ['date', 'full', 'empty', 'revenue', 'expense', 'note'];
      const fields = orderIds.map(id => document.getElementById(id) || form?.querySelector(`[name="${id}"]`)).filter(Boolean);

      // Auto-Tab
      function focusByOffset(currentEl, delta) {
        const idx = Number(currentEl?.dataset?.idx ?? -1);
        if (idx < 0) return;
        const next = fields[idx + delta];
        if (next) next.focus({ preventScroll: true });
      }
      fields.forEach((el, idx) => {
        el.dataset.idx = idx;
        el.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            focusByOffset(el, e.shiftKey ? -1 : 1);
          }
        });
        if (el.type === 'number') el.addEventListener('wheel', (e) => e.preventDefault(), { passive: false });
      });

      // Flatpickr
      function isDark() { return document.documentElement.getAttribute('data-bs-theme') === 'dark'; }
      function toggleCalendarDark(calEl, dark) { if (calEl) calEl.classList.toggle('flatpickr-dark', !!dark); }
      if (window.flatpickr) {
        if (flatpickr.l10ns?.de) flatpickr.localize(flatpickr.l10ns.de);
        const fp = flatpickr('#date', {
          allowInput: true, dateFormat: 'd.m.Y', clickOpens: true, disableMobile: false,
          onClose: () => focusByOffset(document.getElementById('date'), 1),
          onOpen: (s, d, i) => toggleCalendarDark(i.calendarContainer, isDark())
        });
        new MutationObserver(() => {
          const dark = isDark();
          document.querySelectorAll('.flatpickr-calendar').forEach(c => toggleCalendarDark(c, dark));
      }).observe(document.documentElement, {
        attributes: true,
        attributeFilter: ['data-bs-theme']
      });
      }

      // Haptics
      function hapticFeedback() { if (navigator.vibrate) navigator.vibrate(10); }
      form?.querySelectorAll('input, textarea, select').forEach(el => el.addEventListener('focus', hapticFeedback));

      // Required fields group
      const feldIds = ['revenue', 'expense', 'full', 'empty'];
      const felder = feldIds.map(id => document.getElementById(id)).filter(Boolean);
      function getNumericValue(el) {
        const raw = (el?.value ?? '').toString().trim().replace(',', '.');
        const val = parseFloat(raw);
        return Number.isFinite(val) ? val : 0;
      }
      function anyPositive() { return felder.some(el => getNumericValue(el) > 0); }

      function setInlineInvalid(on) {
        felder.forEach(el => { el.classList.toggle('is-invalid', on); el.setAttribute('aria-invalid', on ? 'true' : 'false'); });
        const expenseWrap = document.getElementById('expense')?.closest('.input-group, .form-floating');
        if (on && expenseWrap && !expenseWrap.querySelector('.invalid-feedback')) {
          const fb = document.createElement('div');
          fb.className = 'invalid-feedback';
          fb.textContent = '{{ _("Please enter at least one value for revenue, expenditure, full or empty bottles.") }}';
          (expenseWrap.parentElement || expenseWrap).appendChild(fb);
        }
      }
      function showGlobalError(msg) {
        const btnRow = form?.querySelector('.d-flex.gap-2') || form;
        let alert = form.querySelector('#globalFormError');
        if (!alert) {
          alert = document.createElement('div');
          alert.id = 'globalFormError';
          alert.className = 'alert alert-danger';
          alert.setAttribute('role', 'alert');
          alert.setAttribute('aria-live', 'assertive');
          btnRow.parentNode.insertBefore(alert, btnRow);
        }
        alert.textContent = msg;
        alert.classList.remove('d-none');
        alert.scrollIntoView({ behavior: 'smooth', block: 'center' });
        (felder[0] || form).focus({ preventScroll: true });
      }
      function clearGlobalError() {
        const alert = form?.querySelector('#globalFormError');
        if (alert) { alert.classList.add('d-none'); alert.textContent = ''; }
      }

      // Disable submit button until >0
      const submitBtn = form?.querySelector('.btn.btn-success.flex-grow-1');
      function updateSubmit() {
        if (!submitBtn) return;
        const enabled = anyPositive();
        submitBtn.disabled = !enabled;
        submitBtn.setAttribute('aria-disabled', String(!enabled));
        submitBtn.title = enabled ? '' : '{{ _("Please enter at least one value for revenue, expenditure, full or empty.") }}';
      }

      feldIds.forEach(id => {
        const el = document.getElementById(id);
        el?.addEventListener('input', () => {
          if (anyPositive()) { setInlineInvalid(false); clearGlobalError(); }
          updateSubmit();
        });
        el?.addEventListener('change', updateSubmit);
      });
      updateSubmit();

      // Submit-Handler
      if (form) {

        // Safari/Back-Forward Cache: Remove spinner when users return to the page using the "Back" button
        window.addEventListener('pageshow', (e) => {
          if (e.persisted) form.classList.remove('is-submitting');
        });

        form.addEventListener('submit', (event) => {
          if (!anyPositive()) {
            event.preventDefault(); event.stopPropagation();
            setInlineInvalid(true);
            showGlobalError('{{ _("Please enter at least one value for revenue, expenditure, full or empty.") }}');
            form.classList.add('was-validated');
            updateSubmit();
            return;
          }

          // Browser-Constraint-Validation
          if (!form.checkValidity()) {
            event.preventDefault(); event.stopPropagation();
            form.classList.add('was-validated');
            return;
          }

          // Everything OK: Set spinner class (automatically terminated on the server side by redirect)
          form.classList.add('is-submitting');
          form.classList.add('was-validated');
        }, false);
      }
    });
  </script>

  <script>
  function sortTableByDate() {
    const table = document.querySelector("table");
    const tbody = table.querySelector("tbody");
    const rows = Array.from(tbody.querySelectorAll("tr"));
    const isAsc = table.dataset.sortOrder !== "asc";
    table.dataset.sortOrder = isAsc ? "asc" : "desc";

    rows.sort((a, b) => {
      const cellA = a.querySelector('td[data-col="date"]');
      const cellB = b.querySelector('td[data-col="date"]');
      const sortA = cellA?.getAttribute('data-sort') || '';
      const sortB = cellB?.getAttribute('data-sort') || '';
      // ISO string: lexicographically sortable
      return isAsc ? sortA.localeCompare(sortB) : sortB.localeCompare(sortA);
    });

    rows.forEach(r => tbody.appendChild(r));
  }
  </script>

  <script>
    async function openAttachments(entryId) {
      try {
        const resp = await fetch(`{{ url_for('attachments_routes.attachments_list', entry_id=0) }}`.replace('0', entryId));
        if (!resp.ok) throw new Error('HTTP ' + resp.state);
        const list = await resp.json();

        const ul = document.getElementById('attachmentsList');
        ul.innerHTML = '';

        if (!list || list.length === 0) {
          ul.innerHTML = `<li class="list-group-item text-muted">{{ _('No attachments available.') }}</li>`;
          new bootstrap.Modal(document.getElementById('attachmentsModal')).show();
          return;
        }

        if (list.length === 1) {
          const targetUrl = list[0].view_url || list[0].url;  // Prefer inline
          const w = window.open('', '_blank');                // synchronously from click context
          if (w) {
            try { w.opener = null; } catch (e) {}
            w.location.href = targetUrl;
          } else {
            window.location.assign(targetUrl);                // Fallback: same tab
          }
          return;
        }

        list.forEach(it => {
          const li = document.createElement('li');
          li.className = 'list-group-item d-flex justify-content-between align-items-center';

          const left = document.createElement('div');
          left.className = 'text-truncate';
          left.style.maxWidth = '70%';

          const icon = document.createElement('i');
          icon.className = 'bi-paperclip me-1';

          const nameSpan = document.createElement('span');
          nameSpan.textContent = it.name;

          left.append(icon, nameSpan);

          const openA = document.createElement('a');
          openA.className = 'btn btn-sm btn-outline-primary';
          openA.href = it.view_url; //inline
          openA.target = '_blank';
          openA.textContent = "{{ _('Open') }}";

          li.append(left, openA);
          ul.appendChild(li);
        });

        new bootstrap.Modal(document.getElementById('attachmentsModal')).show();
      } catch (e) {
        console.error(e);
        alert("{{ _('Error loading attachments.') }}");
      }
    }
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const csrf = "{{ csrf_token() }}";
      const token = document.getElementById('temp_token')?.value || '';
      const listEl = document.getElementById('addTempAttachmentsList');
      const badge = document.getElementById('uploadBadge');
      const fileEl = document.getElementById('add_temp_files');
      const btnUp = document.getElementById('btnTempUpload');

      function toggleBtn() { if (btnUp) btnUp.disabled = !(fileEl?.files?.length > 0); }
      fileEl?.addEventListener('change', toggleBtn);
      toggleBtn();

      function updateBadge(count) {
        if (!badge) return;
        if (count > 0) {
          badge.textContent = count > 99 ? '99+' : String(count);
          badge.classList.remove('d-none');
        } else {
          badge.classList.add('d-none');
        }
      }

      async function refreshTempList() {
        if (!token || !listEl) return;
        const url = "{{ url_for('attachments_routes.attachments_temp_list', token='__T__') }}".replace('__T__', token);
        const resp = await fetch(url, { credentials: 'same-origin' });
        if (!resp.ok) return;
        const items = await resp.json();
        listEl.innerHTML = '';
        updateBadge(items.length); // Update badge
        if (!items || items.length === 0) {
          listEl.innerHTML = `<li class="list-group-item text-muted">{{ _('No attachments available.') }}</li>`;
          updateBadge(0);
          return;
        }
        updateBadge(items.length);
        items.forEach(it => {
          const li = document.createElement('li');
          li.className = 'list-group-item d-flex justify-content-between align-items-center';
          const left = document.createElement('div');
          left.className = 'text-truncate'; left.style.maxWidth = '70%';
          const icon = document.createElement('i'); icon.className = 'bi-paperclip me-1';
          const nameSpan = document.createElement('span'); nameSpan.textContent = it.name;
          left.append(icon, nameSpan);
          const actions = document.createElement('div'); actions.className = 'd-flex gap-2';
          const openA = document.createElement('a'); openA.className = 'btn btn-sm btn-outline-primary'; openA.href = it.url; openA.target = '_blank'; openA.textContent = "{{ _('Open') }}";
          const delBtn = document.createElement('button'); delBtn.className = 'btn btn-sm btn-outline-danger'; delBtn.dataset.id = it.id; delBtn.textContent = "{{ _('Delete') }}";
          delBtn.addEventListener('click', async (ev) => {
            ev.preventDefault();
            if (!confirm('{{ _("Delete attachment for real?") }}')) return;
            const attId = delBtn.dataset.id;
            await fetch(`{{ url_for('attachments_routes.attachments_temp_delete', att_id=0) }}`.replace('0', attId), { method: 'POST', headers: { 'X-CSRF-Token': "{{ csrf_token() }}" }, credentials: 'same-origin' });
            refreshTempList();
          });
          actions.append(openA, delBtn);
          li.append(left, actions);
          listEl.appendChild(li);
        });
      }

      const uploadModalEl = document.getElementById('uploadModal');
      if (uploadModalEl) uploadModalEl.addEventListener('shown.bs.modal', refreshTempList);

      btnUp?.addEventListener('click', async () => {
        if (!token || !fileEl || !fileEl.files?.length) return;
        for (const f of fileEl.files) {
          const fd = new FormData();
          fd.append('files', f);
          fd.append('csrf_token', csrf);
          const url = "{{ url_for('attachments_routes.attachments_temp_upload', token='__T__') }}".replace('__T__', token);
          const resp = await fetch(url, { method: 'POST', body: fd, credentials: 'same-origin' });
          alert(await resp.text() || '{{ _("Upload failed") }}');
        }
        fileEl.value = '';
        refreshTempList();
      });

      refreshTempList();
    });
  </script>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const form    = document.getElementById('filtersForm');
    const elRange = document.getElementById('filter_daterange');
    const elFrom  = document.getElementById('filter_from');
    const elTo    = document.getElementById('filter_to');

    // -----------------------------
    // Auto-Submit: Attachments
    // -----------------------------
    const attachmentsSelect = document.getElementById('filter_attachments');
    if (attachmentsSelect && form) {
      attachmentsSelect.addEventListener('change', () => {
        form.requestSubmit();
      });
    }

    // -----------------------------
    // Auto-Submit: Year
    // -----------------------------
    const yearSelect = document.getElementById('filter_year');
    if (yearSelect && form) {
      yearSelect.addEventListener('change', () => {
        form.requestSubmit();
      });
    }

    // -----------------------------
    // Search (filter_q):
    // Submit on change/blur + optional debounce on typing
    // -----------------------------
    const searchInput = document.getElementById('filter_q');

    // Debounce helper
    function debounce(fn, wait = 500) {
      let t = null;
      return function (...args) {
        clearTimeout(t);
        t = setTimeout(() => fn.apply(this, args), wait);
      };
    }

    // Last successfully transmitted q value (loop/double submit protection)
    let lastSubmittedQ = (searchInput?.value || '').trim();

    // Only submits if the value has actually changed
    const submitIfQChanged = () => {
      if (!form || !searchInput) return;
      const q = searchInput.value.trim();
      if (q === lastSubmittedQ) return;
      lastSubmittedQ = q;
      form.requestSubmit();
    };

    if (searchInput && form) {
      // 1) CHANGE: User confirms/exits field with changed value
      searchInput.addEventListener('change', submitIfQChanged);

      // 2) BLUR: When leaving the field (only if value is different)
      searchInput.addEventListener('blur', submitIfQChanged);

      // 3) (OPTIONAL) Debounce when typing: filter after 500ms of inactivity
      //    If you do NOT want live filtering, comment out the next line.
      searchInput.addEventListener('input', debounce(submitIfQChanged, 1500));
    }

    // -----------------------------
    // Period / Flatpickr
    // -----------------------------
    // Local YYYY-MM-DD (no UTC shift)
    const fmtLocal = (d) => {
      if (!d) return '';
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${y}-${m}-${day}`;
    };

    // Re-submit only if there is a genuine change from/to (loop protection)
    const submitIfDateChanged = (() => {
      let lastKey = `${elFrom?.value || ''}|${elTo?.value || ''}`;
      return () => {
        const key = `${elFrom?.value || ''}|${elTo?.value || ''}`;
        if (key === lastKey) return;
        lastKey = key;
        form?.requestSubmit();
      };
    })();

    // Initialize flatpickr for period
    if (!window.flatpickr || !elRange) return;
    if (flatpickr.l10ns?.de) flatpickr.localize(flatpickr.l10ns.de);
    const isDark = () => document.documentElement.getAttribute('data-bs-theme') === 'dark';

    let hydrating = true;
    const fp = flatpickr(elRange, {
      mode: 'range',
      dateFormat: 'Y-m-d',
      altInput: true,
      altFormat: 'd.m.Y',
      allowInput: true,
      clickOpens: true,
      locale: { rangeSeparator: ' – ', firstDayOfWeek: 1 },
      onOpen: (_, __, i) => i.calendarContainer.classList.toggle('flatpickr-dark', isDark()),
      onChange: (dates) => {
        const [from, to] = dates;
        elFrom.value = fmtLocal(from);
        elTo.value   = fmtLocal(to);
        if (!hydrating && from && to) submitIfDateChanged();
      }
    });
    
    const preset = [elFrom.value, elTo.value].filter(Boolean);
      if (preset.length) fp.setDate(preset, false, 'Y-m-d');
      hydrating = false;

      const mo = new MutationObserver(() => {
        document.querySelectorAll('.flatpickr-calendar')
          .forEach(c => c.classList.toggle('flatpickr-dark', isDark()));
      });
      mo.observe(document.documentElement, { attributes: true, attributeFilter: ['data-bs-theme'] });
    });
  </script>

  <script>
    function applyStackedVisibility() {
      const isStacked = window.matchMedia('(max-width: 768px)').matches;
      const rows = document.querySelectorAll('table.table-stacked tbody tr');

      rows.forEach(tr => {
        // existing flags as before
        const vV = Number(tr.getAttribute('data-full-val')   || 0);
        const lV = Number(tr.getAttribute('data-empty-val')   || 0);
        const eV = Number(tr.getAttribute('data-revenue-val')  || 0);
        const aV = Number(tr.getAttribute('data-expense-val')   || 0);

        // Cells
        const tdInv = tr.querySelector('td[data-col="inventory"]');
        const tdKas = tr.querySelector('td[data-col="cashBalance"]');

        // Get the arrow chip in the badge
        const invArrow = tdInv?.querySelector('.dir-arrow');
        const kasArrow = tdKas?.querySelector('.dir-arrow');

        // Inventory: full vs. empty
        if (invArrow) {
          if (vV > lV) { invArrow.textContent = '▲'; invArrow.classList.add('dir-up'); invArrow.classList.remove('dir-down'); }
          else if (lV > vV) { invArrow.textContent = '▼'; invArrow.classList.add('dir-down'); invArrow.classList.remove('dir-up'); }
          else { invArrow.textContent = ''; invArrow.classList.remove('dir-up','dir-down'); }
        }

        // Cash register: Revenue vs. Expense
        if (kasArrow) {
          if (eV > aV) { kasArrow.textContent = '▲'; kasArrow.classList.add('dir-up'); kasArrow.classList.remove('dir-down'); }
          else if (aV > eV) { kasArrow.textContent = '▼'; kasArrow.classList.add('dir-down'); kasArrow.classList.remove('dir-up'); }
          else { kasArrow.textContent = ''; kasArrow.classList.remove('dir-up','dir-down'); }
        }
      });

      // Reset desktop visibility
      if (!isStacked) {
        rows.forEach(tr => tr.querySelectorAll('td[data-col]').forEach(td => td.style.removeProperty('display')));
      }
    }

    document.addEventListener('DOMContentLoaded', applyStackedVisibility);
    window.addEventListener('resize', () => {
      clearTimeout(window.__bbStackedTO);
      window.__bbStackedTO = setTimeout(applyStackedVisibility, 50);
    });
  </script>

  <!-- Switch table to stacked if width is too small -->
  <script>
    function toggleStackedTable() {
      const table = document.querySelector('table.table-stacked');
      if (!table) return;
      const containerWidth = table.parentElement.offsetWidth;
      const tableWidth = table.scrollWidth;
      table.classList.toggle('is-stacked', tableWidth > containerWidth);
    }

    // Initially, after complete loading, and during resizing
    document.addEventListener('DOMContentLoaded', toggleStackedTable);
    window.addEventListener('load', toggleStackedTable);
    window.addEventListener('resize', () => {
      clearTimeout(window.__stackedTO);
      window.__stackedTO = setTimeout(toggleStackedTable, 100);
    });

    // Also reacts to size changes of the parent container (e.g., collapse/filter)
    const tableParent = document.querySelector('table.table-stacked')?.parentElement;
    if (tableParent && 'ResizeObserver' in window) {
      const ro = new ResizeObserver(() => toggleStackedTable());
      ro.observe(tableParent);
    }
  </script>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const badge = document.getElementById('filterBadge');
    const params = new URLSearchParams(window.location.search);

    const isActive = ['q', 'from', 'to', 'year', 'attachments'].some(key => {
      const val = params.get(key);
      return val && val.trim() !== '';
    });

    if (badge && isActive) {
      badge.classList.remove('d-none');
    }
  });
  </script>
  {% endblock %}