{% extends "base.html" %}
{% block content %}
<!-- Filter: separate full-width container above the table -->
<div class="row g-3 mb-3">
  <div class="col-12">
    <div class="card shadow-sm mb-2">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span>{{ _('Filter') }}</span>
        <!-- Toggle button only on mobile -->
        <button class="btn btn-sm btn-outline-secondary d-md-none"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#collapseFilters"
                aria-expanded="false"
                aria-controls="collapseFilters">
          <i class="bi-chevron-down"></i>
        </button>
      </div>
      <!-- default open; for mobile, you can initially close via JS -->
      <div id="collapseFilters" class="collapse show">
        <div class="card-body">
          <form method="get" class="row row-cols-1 row-cols-md-auto g-2 align-items-end form-compact" id="filtersForm">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <div class="col">
                <label class="form-label">{{ _('Search') }}</label>
                <div class="input-group">
                  <span class="input-group-text"><i class="bi-search"></i></span>
                  <input type="text"
                        id="filter_q"
                        name="q"
                        class="form-control"
                        placeholder="{{ _('Date/Note') }}"
                        value="{{ request.args.get('q','') }}"
                        autocomplete="off">
                </div>
              </div>
              <div class="col">
                <label for="filter_daterange" class="form-label mb-1">{{ _('Time period') }}</label>
                <div class="input-group">
                  <span class="input-group-text"><i class="bi-calendar"></i></span>
                  <input type="text" id="filter_daterange" class="form-control"
                    placeholder="{{ _('TT.MM.JJJJ – TT.MM.JJJJ') }}" autocomplete="off">
                  <input type="hidden" name="from" id="filter_from" value="{{ request.args.get('from','') }}">
                  <input type="hidden" name="to" id="filter_to" value="{{ request.args.get('to','') }}">
                </div>
              </div>
              <div class="col d-flex gap-2">
                <button class="btn btn-primary" type="submit">
                  <i class="bi-funnel me-1"></i> {{ _('Filter') }}
                </button>
                <a class="btn btn-outline-secondary" href="{{ url_for('bbalance_routes.index') }}">
                <i class="bi bi-eraser me-1"></i>{{ _('Reset filter') }}
              </a>
              </div>
            </form>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- End Filter -->

<div class="row g-3 mb-3">
  <div class="col-12">
    <div class="card shadow-sm mb-2">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span>{{ _('Audit history') }}</span>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-sm table-striped align-middle">
            <thead class="table-light">
              <tr>
                <th>{{ _('Time period') }}</th>
                <th>{{ _('User') }}</th>
                <th>{{ _('Action') }}</th>
                <th>{{ _('Entry-ID') }}</th>
                <th>{{ _('Details') }}</th>
              </tr>
            </thead>
            <tbody>
            {% for a in logs %}
              <tr>
                <td data-label="{{ _('Time') }}" class="text-nowrap">{{ a.created_at.strftime('%d.%m.%Y %H:%M') }}</td>
                <td data-label="{{ _('User') }}">{{ a.username or ('#'+(a.user_id|string)) }}</td>
                <td data-label="{{ _('Action') }}">{{ a.action }}</td>
                <td data-label="{{ _('Entry-ID') }}">{{ a.entry_id or '—' }}</td>
                <td data-label="{{ _('Details') }}">{{ a.detail or '—' }}</td>
              </tr>
            {% else %}
              <tr>
                <td data-label="{{ _('No entries.') }}" colspan="5" class="text-center text-muted">{{ _('No entries.') }}</td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', () => {
    if (window.flatpickr) {
      if (flatpickr.l10ns?.de) flatpickr.localize(flatpickr.l10ns.de);
      flatpickr("#filter_daterange", {
        mode: "range",
        dateFormat: "d.m.Y",
        allowInput: true,
        onChange: function(selectedDates, dateStr, instance) {
          if (selectedDates.length === 2) {
            // Set hidden fields for backend filter
            document.getElementById('filter_from').value = flatpickr.formatDate(selectedDates[0], "Y-m-d");
            document.getElementById('filter_to').value = flatpickr.formatDate(selectedDates[1], "Y-m-d");
          } else if (selectedDates.length === 1) {
            document.getElementById('filter_from').value = flatpickr.formatDate(selectedDates[0], "Y-m-d");
            document.getElementById('filter_to').value = "";
          } else {
            document.getElementById('filter_from').value = "";
            document.getElementById('filter_to').value = "";
          }
        }
      });
    }
  });
</script>
{% endblock %}