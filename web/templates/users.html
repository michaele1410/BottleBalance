<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Benutzerverwaltung</title>
  https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css
  https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css
  https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js
</head>
<body>
<div class="container mt-4">
  <h2>Benutzerverwaltung</h2>

  <!-- Neuer Benutzer -->
  <div class="card mb-4">
    <div class="card-header">Neuen Benutzer anlegen</div>
    <div class="card-body">
      <form class="row g-3" method="post" action="{{ url_for('users_add') }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="col-md-3">
          <label class="form-label">Benutzername</label>
          <input type="text" name="username" class="form-control" required>
        </div>
        <div class="col-md-3">
          <label class="form-label">E-Mail</label>
          <input type="email" name="email" class="form-control">
        </div>
        <div class="col-md-3">
          <label class="form-label">Rolle</label>
          <select name="role" class="form-select">
            {% for role_name in ROLES.keys() %}
            <option value="{{ role_name }}">{{ role_name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Passwort (min. 8)</label>
          <input type="password" name="password" minlength="8" class="form-control" required>
        </div>
        <div class="col-12">
          <button class="btn btn-primary" type="submit"><i class="bi bi-person-plus me-1"></i>Anlegen</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Liste der Benutzer -->
  <div class="table-responsive">
    <table class="table table-striped align-middle">
      <thead>
        <tr>
          <th>Nutzer</th>
          <th>E-Mail</th>
          <th>Rolle</th>
          <th>Aktiv</th>
          <th>Geschäftsführend</th>
          <th>Passwort</th>
          <th>Reset-Link</th>
          <th>Löschen</th>
        </tr>
      </thead>
      <tbody>
      {% for u in users %}
        <tr>
          <td class="text-nowrap">
            <strong>{{ u.username }}</strong><br>
            <small class="text-muted">ID: {{ u.id }}</small>
          </td>

          <td>{{ u.email or '–' }}</td>

          <!-- Rollenwechsel -->
          <td>
            <form method="post" action="{{ url_for('users_change_role', uid=u.id) }}" class="d-flex gap-2 align-items-center">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <select name="role" class="form-select form-select-sm" style="min-width: 9rem;">
                {% for role_name in ROLES.keys() %}
                  <option value="{{ role_name }}" {% if role_name == u.role %}selected{% endif %}>
                    {{ role_name }}
                  </option>
                {% endfor %}
              </select>
              <button class="btn btn-sm btn-outline-primary"><i class="bi bi-save"></i></button>
            </form>
          </td>

          <!-- Aktiv-Toggle -->
          <td>
            <form method="post" action="{{ url_for('users_toggle', uid=u.id) }}" class="d-inline">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              {% if u.active %}
                <button class="btn btn-sm btn-success" title="Deaktivieren">
                  <i class="bi bi-toggle-on"></i> Aktiv
                </button>
              {% else %}
                <button class="btn btn-sm btn-outline-secondary" title="Aktivieren">
                  <i class="bi bi-toggle-off"></i> Inaktiv
                </button>
              {% endif %}
            </form>
          </td>

          <!-- Geschäftsführend (can_approve) -->
          <td>
            <form method="post" action="{{ url_for('users_toggle_approve', uid=u.id) }}" class="d-inline">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              {% if u.can_approve %}
                <button class="btn btn-sm btn-success" title="Berechtigung entfernen">
                  <i class="bi bi-check2-circle"></i> Ja
                </button>
              {% else %}
                <button class="btn btn-sm btn-outline-secondary" title="Berechtigung vergeben">
                  <i class="bi bi-dash-circle"></i> Nein
                </button>
              {% endif %}
            </form>
          </td>

          <!-- Passwort setzen -->
          <td>
            <form method="post" action="{{ url_for('users_reset_pw', uid=u.id) }}" class="d-flex gap-2">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <input type="password" name="password" minlength="8" placeholder="neues Passwort" class="form-control form-control-sm" required>
              <button class="btn btn-sm btn-outline-primary" title="Passwort setzen">
                <i class="bi bi-key"></i>
              </button>
            </form>
          </td>

          <!-- Reset-Link per E-Mail -->
          <td>
            <form method="post" action="{{ url_for('users_reset_link', uid=u.id) }}" class="d-inline">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button class="btn btn-sm btn-outline-secondary" title="Reset-Link senden">
                <i class="bi bi-envelope"></i>
              </button>
            </form>
          </td>

          <!-- Löschen -->
          <td>
            <form method="post" action="{{ url_for('users_delete', uid=u.id) }}" class="d-inline"
                  onsubmit="return confirm('Benutzer wirklich löschen? Dies kann nicht rückgängig gemacht werden.');">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button class="btn btn-sm btn-outline-danger" title="Löschen">
                <i class="bi bi-trash"></i>
              </button>
            </form>
          </td>

        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="mt-3">
    <a href="{{ url_for('index') }}" class="btn btn-secondary">Zurück</a>
  </div>
</div>
</body>
</html>
