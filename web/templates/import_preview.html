
{% extends "base.html" %}
{% block content %}

<div class="card shadow-sm mb-3">
  <div class="card-body">
    <!-- Titel + Zurück-Button -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h1 class="h5 mb-0">{{ _('CSV-Import – Vorschau') }}</h1>
      <a href="{{ url_for('bbalance_routes.index') }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left me-1"></i> {{ _('Zurück') }}
      </a>
    </div>

    <!-- Zusammenfassung -->
    <div class="mb-2 text-muted">
      <span class="me-3">{{ _('Gesamt:') }} <strong>{{ total }}</strong></span>
      <span class="me-3">{{ _('potentielle Duplikate:') }} <strong>{{ dup_count }}</strong></span>
      {% if replace_all %}
        <span class="fw-semibold text-danger">{{ _('Modus: Alle bestehenden Einträge werden ersetzt') }}</span>
      {% else %}
        <span>{{ _('Modus: Anhängen (bestehende Einträge bleiben erhalten)') }}</span>
      {% endif %}
    </div>

    <!-- Legende -->
    <div class="d-flex flex-wrap gap-2 mb-3">
      <span class="badge bg-warning-subtle text-warning-emphasis border">{{ _('Duplikat') }}</span>
      <span class="badge bg-danger-subtle text-danger-emphasis border">{{ _('Fehler in Zeile') }}</span>
    </div>

    <!-- Mapping-Bereich -->
    {% if allow_mapping %}
    <div class="card mb-3">
      <div class="card-header">
        <strong>{{ _('Feldzuordnung (Mapping)') }}</strong>
      </div>
      <div class="card-body">
        <form method="post" action="{{ url_for('import_preview') }}">
          <input type="hidden" name="token" value="{{ token }}">
          <input type="hidden" name="remap" value="1">
          <input type="hidden" name="replace_all" value="{{ 'on' if replace_all else '' }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

          {% set fields = [
            {'key': 'Datum',     'label': _('Datum')},
            {'key': 'Vollgut',   'label': _('Vollgut')},
            {'key': 'Leergut',   'label': _('Leergut')},
            {'key': 'Einnahme',  'label': _('Einnahme')},
            {'key': 'Ausgabe',   'label': _('Ausgabe')},
            {'key': 'Bemerkung', 'label': _('Bemerkung')}
          ] %}

          <div class="row g-3">
            {% for f in fields %}
              {% set field_id = f.key|lower|replace(' ', '_') %}
              <div class="col-12 col-md-4">
                <div class="form-floating">
                  <select class="form-select" name="map_{{ field_id }}" id="map_{{ field_id }}">
                    <option value="__none__">– {{ _('keine') }} –</option>
                    {% for h in headers %}
                      <option value="{{ loop.index0 }}"
                        {% if mapping and (mapping.get(f.key) is not none) and mapping.get(f.key) == loop.index0 %}selected{% endif %}>
                        {{ h }}
                      </option>
                    {% endfor %}
                  </select>
                  <label for="map_{{ field_id }}"><strong>{{ f.label }}</strong></label>
                </div>
              </div>
            {% endfor %}
          </div>

          <div class="text-end mt-3">
            <button type="submit" class="btn btn-primary">
              <i class="bi bi-arrow-repeat me-1"></i> {{ _('Mapping anwenden & Vorschau aktualisieren') }}
            </button>
          </div>
        </form>
      </div>
    </div>
    {% endif %}

    <!-- Vorschau-Tabelle -->
    <div class="card mb-3">
      <div class="card-header">
        <strong>{{ _('Vorschau') }}</strong>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive border-top">
          <table class="table table-sm mb-0 align-middle">
            <thead class="table-light">
              <tr>
                <th>#</th>
                <th>{{ _('Datum') }}</th>
                <th class="text-end">{{ _('Vollgut') }}</th>
                <th class="text-end">{{ _('Leergut') }}</th>
                <th class="text-end">{{ _('Einnahme') }}</th>
                <th class="text-end">{{ _('Ausgabe') }}</th>
                <th>{{ _('Bemerkung') }}</th>
                <th>{{ _('Status') }}</th>
              </tr>
            </thead>
            <tbody>
              {% for r in preview_rows %}
                {% set row_class = 'table-danger' if r.errors|length > 0 else ('table-warning' if r.is_duplicate and not replace_all else '') %}
                <tr class="{{ row_class }}">
                  <td>{{ r.line_no }}</td>
                  <td>{{ r.datum and format_date_de(r.datum) or '–' }}</td>
                  <td class="text-end">{{ r.vollgut }}</td>
                  <td class="text-end">{{ r.leergut }}</td>
                  <td class="text-end">{{ r.einnahme }}</td>
                  <td class="text-end">{{ r.ausgabe }}</td>
                  <td>{{ r.bemerkung }}</td>
                  <td>
                    {% if r.errors|length > 0 %}
                      <div class="fw-semibold">{{ _('Fehler:') }}</div>
                      <ul class="mb-0 ps-3">
                        {% for e in r.errors %}<li>{{ e }}</li>{% endfor %}
                      </ul>
                    {% else %}
                      {% if replace_all %}
                        {{ _('wird importiert') }}
                      {% else %}
                        {% if r.is_duplicate %}
                          {{ _('Duplikat – wird übersprungen (Standard)') }}
                        {% else %}
                          {{ _('neu – wird importiert') }}
                        {% endif %}
                      {% endif %}
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Commit-Formular -->
    <form action="{{ url_for('import_commit') }}" method="post" class="d-flex flex-wrap gap-3 align-items-center">
      <input type="hidden" name="token" value="{{ token }}">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

      {% if not replace_all %}
        <div class="d-flex flex-column">
          <label class="d-flex align-items-center gap-2">
            <input type="radio" name="mode" value="skip_dups" checked>
            <span>{{ _('Duplikate überspringen (empfohlen)') }}</span>
          </label>
          <label class="d-flex align-items-center gap-2">
            <input type="radio" name="mode" value="insert_all">
            <span>{{ _('Alle einfügen (auch Duplikate)') }}</span>
          </label>
        </div>
      {% else %}
        <input type="hidden" name="mode" value="insert_all">
      {% endif %}

      <label class="d-flex align-items-center gap-2 mb-0">
        <input type="checkbox" name="import_invalid">
        <span>{{ _('Auch Zeilen mit Fehlern importieren (nicht empfohlen)') }}</span>
      </label>

      <div class="ms-auto d-flex flex-wrap gap-2">
        <button type="submit" class="btn btn-success">
          <i class="bi bi-check-lg me-1"></i> {{ _('Import jetzt durchführen') }}
        </button>
        <a href="{{ url_for('bbalance_routes.index') }}" class="btn btn-outline-secondary">
          {{ _('Abbrechen') }}
        </a>
      </div>
    </form>
  </div>
</div>

{% endblock %}
