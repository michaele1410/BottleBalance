
{% extends "base.html" %}
{% block content %}

<div class="row g-3 mb-4">
  <!-- Inventar -->
  <div class="col-12 col-lg-4">
    <div class="card shadow-sm h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span>{{ _('Inventar (aktuell):') }}</span>
        <span class="badge bg-primary">{{ inv_aktuell }} Flaschen</span>
      </div>
      <div class="card-body">
        <div class="ratio" style="--bs-aspect-ratio: 100%;">
          <canvas id="sparklineInv"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Kassenbestand -->
  <div class="col-12 col-lg-4">
    <div class="card shadow-sm h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span>{{ _('Kassenbestand (aktuell):') }}</span>
        <span class="badge bg-success">{{ format_eur_de(kas_aktuell) }}</span>
      </div>
      <div class="card-body">
        <div class="ratio" style="--bs-aspect-ratio: 100%;">
          <canvas id="sparklineKas"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Formular für neuen Datensatz -->
{% if can_add %}
<div class="col-12 col-lg-4">
  <div class="card shadow-sm h-100">
    <div class="card-body">
      <h2 class="h6 mb-3">{{ _('Neuen Datensatz hinzufügen') }}</h2>
      <form method="post" action="{{ url_for('add') }}" id="transaction-form" novalidate>
        
        <!-- Datum -->
        <div class="form-floating mb-3">
          <input type="text" name="datum" id="datum" class="form-control" placeholder="Datum" value="{{ default_date }}" required autofocus>
          <label for="datum">{{ _('Datum') }}</label>
        </div>

        <!-- Vollgut -->
        <div class="form-floating mb-3">
          <input id="vollgut" name="vollgut" type="number" inputmode="numeric" min="0" step="1" class="form-control" placeholder="0" autocomplete="off">
          <label for="vollgut">{{ _('Vollgut') }}</label>
        </div>

        <!-- Leergut -->
        <div class="form-floating mb-3">
          <input id="leergut" name="leergut" type="number" inputmode="numeric" min="0" step="1" class="form-control" placeholder="0" autocomplete="off">
          <label for="leergut">{{ _('Leergut') }}</label>
        </div>

        <!-- Einnahme -->
        <div class="input-group mb-3">
          <span class="input-group-text">€</span>
          <div class="form-floating flex-grow-1">
            <input name="einnahme" type="number" step="0.01" inputmode="decimal" class="form-control" placeholder="0.00" id="einnahme" autocomplete="off">
            <label for="einnahme">{{ _('Einnahme') }}</label>
          </div>
        </div>

        <!-- Ausgabe -->
        <div class="input-group mb-3">
          <span class="input-group-text">€</span>
          <div class="form-floating flex-grow-1">
            <input name="ausgabe" type="number" step="0.01" inputmode="decimal" class="form-control" placeholder="0.00" id="ausgabe" autocomplete="off">
            <label for="ausgabe">{{ _('Ausgabe') }}</label>
          </div>
        </div>

        <!-- Bemerkung -->
        <div class="form-floating mb-3">
          <input id="bemerkung" name="bemerkung" class="form-control" maxlength="500" placeholder="{{ _('Notiz') }}">
          <label for="bemerkung">{{ _('Bemerkung') }}</label>
        </div>

        <button class="btn btn-success w-100">
          <i class="bi-plus-lg me-1"></i> {{ _('Hinzufügen') }}
        </button>
      </form>
    </div>
  </div>
</div>
{% endif %}
</div>

<!-- Tabelle -->
<div class="card shadow-sm">
  <div class="card-body">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2 mb-3">
      <h2 class="h5 m-0">{{ _('Einträge') }}</h2>

      <!-- Filter -->
      <form method="get" class="row g-2 align-items-end w-100 w-md-auto">
        <div class="col-12 col-md-3">
          <label class="form-label">{{ _('Suche') }}</label>
          <input type="text" name="q" class="form-control" placeholder="{{ _('Datum/Bemerkung') }}" value="{{ request.args.get('q','') }}">
        </div>
        <div class="col-6 col-md-2">
          <label class="form-label">{{ _('Von') }}</label>
          <input type="date" name="from" class="form-control" value="{{ request.args.get('from','') }}">
        </div>
        <div class="col-6 col-md-2">
          <label class="form-label">{{ _('Bis') }}</label>
          <input type="date" name="to" class="form-control" value="{{ request.args.get('to','') }}">
        </div>
        <div class="col-12 col-md-auto">
          <div class="d-flex flex-row flex-wrap gap-2 align-items-center">
            <button class="btn btn-outline-primary" type="submit">
              <i class="bi-search me-1"></i> {{ _('Filtern') }}
            </button>
            <a class="btn btn-outline-secondary" href="{{ url_for('index') }}">
              <i class="bi-x-circle me-1"></i> {{ _('Zurücksetzen') }}
            </a>
          </div>
        </div>
      </form>

      <!-- Export -->
      <div class="col-12 col-md-auto">
        <div class="d-flex flex-row flex-wrap gap-2 align-items-center">
          {% if can_export_pdf %}
            <a class="btn btn-outline-danger" href="{{ url_for('export_pdf', q=request.args.get('q'), from=request.args.get('from'), to=request.args.get('to')) }}">
              <i class="bi-file-earmark-pdf me-1"></i> PDF
            </a>
          {% endif %}
          {% if can_export_csv %}
            <a class="btn btn-outline-primary" href="{{ url_for('export_csv', q=request.args.get('q'), from=request.args.get('from'), to=request.args.get('to')) }}">
              <i class="bi-download me-1"></i> CSV
            </a>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Tabelle -->
    <div class="table-responsive">
      <table class="table table-sm align-middle table-striped">
        <thead class="table-light">
          <tr>
            <th>{{ _('Datum') }}</th>
            <th>{{ _('Vollgut') }}</th>
            <th>{{ _('Leergut') }}</th>
            <th>{{ _('Inventar') }}</th>
            <th>{{ _('Einnahme') }}</th>
            <th>{{ _('Ausgabe') }}</th>
            <th>{{ _('Kassenbestand') }}</th>
            <th>{{ _('Bemerkung') }}</th>
            <th class="text-end">{{ _('Aktionen') }}</th>
          </tr>
        </thead>
        <tbody>
        {% for e in entries %}
          <tr>
            <td>{{ format_date_de(e.datum) }}</td>
            <td>{{ e.vollgut }}</td>
            <td>{{ e.leergut }}</td>
            <td>{{ e.inventar }}</td>
            <td>{{ format_eur_de(e.einnahme) }}</td>
            <td>{{ format_eur_de(e.ausgabe) }}</td>
            <td>{{ format_eur_de(e.kassenbestand) }}</td>
            <td>{{ e.bemerkung }}</td>
            <td class="text-end">
              <a class="btn btn-sm btn-outline-primary" href="{{ url_for('edit', entry_id=e.id) }}" title="{{ _('Bearbeiten') }}">
                <i class="bi-pencil-square"></i>
              </a>
              <form method="post" action="{{ url_for('delete', entry_id=e.id) }}" class="d-inline"
                    onsubmit="return confirm('{{ _('Eintrag wirklich löschen?') }}');">
                <button class="btn btn-sm btn-outline-danger" title="{{ _('Löschen') }}">
                  <i class="bi-trash"></i>
                </button>
              </form>
            </td>
          </tr>
        {% else %}
          <tr><td colspan="9" class="text-center text-muted">{{ _('Keine Einträge vorhanden.') }}</td></tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

{% endblock %}


{% block scripts %}
<script>
(function () {
  // Daten aus Flask
  const labelsRaw = {{ entries|map(attribute='datum')|list|tojson }};
  const dataInv   = {{ series_inv|tojson }};
  const dataKas   = {{ series_kas|tojson }};

  // Labels formatiert (de-DE)
  const labels = labelsRaw.map(d => {
    try { return new Date(d).toLocaleDateString('de-DE'); } catch { return String(d); }
  });

  // Bootstrap-Farben (Theme-aware)
  const css          = getComputedStyle(document.documentElement);
  const colorPrimary = (css.getPropertyValue('--bs-primary')       || '#0d6efd').trim();
  const colorSuccess = (css.getPropertyValue('--bs-success')       || '#198754').trim();
  const gridColor    = (css.getPropertyValue('--bs-border-color')  || '#dee2e6').trim();

  const baseOptions = {
    responsive: true,
    maintainAspectRatio: false,
    interaction: { intersect: false, mode: 'index' },
    plugins: {
      legend: { display: false },
      tooltip: {
        callbacks: {
          title: (items) => items[0]?.label ?? '',
          label: (ctx) => {
            const val = ctx.parsed.y;
            if (ctx.dataset.label === 'Kassenbestand') {
              return new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' }).format(val);
            }
            return `${val} {{ _('Flaschen') }}`;
          }
        }
      }
    },
    scales: {
      x: { display: false, grid: { display: false } },
      y: { display: false, grid: { color: gridColor } }
    }
  };

  function makeGradient(ctx, baseColor) {
    const g = ctx.createLinearGradient(0, 0, 0, ctx.canvas.height || 80);
    g.addColorStop(0, baseColor + '33');
    g.addColorStop(1, baseColor + '00');
    return g;
  }

  // Inventar-Chart
  const invCanvas = document.getElementById('sparklineInv');
  if (invCanvas && window.Chart) {
    const invCtx = invCanvas.getContext('2d');
    new Chart(invCtx, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: 'Inventar',
          data: dataInv,
          borderColor: colorPrimary,
          backgroundColor: makeGradient(invCtx, colorPrimary),
          borderWidth: 2,
          fill: true,
          tension: 0.35,
          pointRadius: 3,
          pointBackgroundColor: colorPrimary,
          pointHoverRadius: 5,
          pointHoverBackgroundColor: colorPrimary,
          pointHoverBorderWidth: 3
        }]
      },
      options: baseOptions
    });
  }

  // Kassenbestand-Chart
  const kasCanvas = document.getElementById('sparklineKas');
  if (kasCanvas && window.Chart) {
    const kasCtx = kasCanvas.getContext('2d');
    new Chart(kasCtx, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: 'Kassenbestand',
          data: dataKas,
          borderColor: colorSuccess,
          backgroundColor: makeGradient(kasCtx, colorSuccess),
          borderWidth: 2,
          fill: true,
          tension: 0.35,
          pointRadius: 3,
          pointBackgroundColor: colorSuccess,
          pointHoverRadius: 5,
          pointHoverBackgroundColor: colorSuccess,
          pointHoverBorderWidth: 3
        }]
      },
      options: baseOptions
    });
  }
})();
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // ---------- Einstellungen & Referenzen ----------
  const form = document.getElementById('transaction-form');

  // Reihenfolge für Auto-Tab
  const orderIds = ['datum', 'vollgut', 'leergut', 'einnahme', 'ausgabe', 'bemerkung'];
  const fields = orderIds
    .map(id => document.getElementById(id) || form?.querySelector(`[name="${id}"]`))
    .filter(Boolean);

  // ---------- Auto-Tab (Enter = weiter, Shift+Enter = zurück) ----------
  function focusByOffset(currentEl, delta) {
    const idx = Number(currentEl?.dataset?.idx ?? -1);
    if (idx < 0) return;
    const next = fields[idx + delta];
    if (next) next.focus({ preventScroll: true });
  }

  fields.forEach((el, idx) => {
    el.dataset.idx = idx;
    el.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        focusByOffset(el, e.shiftKey ? -1 : 1);
      }
    });

    // Verhindert versehentliches Scroll-Ändern bei Number-Feldern
    if (el.type === 'number') {
      el.addEventListener('wheel', (e) => e.preventDefault(), { passive: false });
    }
  });

  // ---------- Flatpickr mit DE & Dark-Mode-Brücke ----------
  function isDark() {
    return document.documentElement.getAttribute('data-bs-theme') === 'dark';
  }
  function toggleCalendarDark(calEl, dark) {
    if (!calEl) return;
    calEl.classList.toggle('flatpickr-dark', !!dark);
  }

  if (window.flatpickr) {
    if (flatpickr.l10ns?.de) flatpickr.localize(flatpickr.l10ns.de);

    const fp = flatpickr('#datum', {
      allowInput: true,
      dateFormat: 'd.m.Y',
      clickOpens: true,
      disableMobile: false, // auf true setzen, wenn du immer Flatpickr willst
      onClose: () => {
        const el = document.getElementById('datum');
        focusByOffset(el, 1);
      },
      onOpen: (selectedDates, dateStr, instance) => {
        toggleCalendarDark(instance.calendarContainer, isDark());
      }
    });

    // Theme-Wechsel übernehmen
    const themeObserver = new MutationObserver(() => {
      const dark = isDark();
      document.querySelectorAll('.flatpickr-calendar').forEach(c => toggleCalendarDark(c, dark));
    });
    themeObserver.observe(document.documentElement, { attributes: true, attributeFilter: ['data-bs-theme'] });
  }

  // ---------- Haptisches Feedback (iOS/unterstützte Geräte) ----------
  function hapticFeedback() { if (navigator.vibrate) navigator.vibrate(10); }
  form?.querySelectorAll('input, textarea, select').forEach(el => {
    el.addEventListener('focus', hapticFeedback);
  });

  // ---------- Bootstrap Client-Validation ----------
  if (form) {
    form.addEventListener('submit', (event) => {
      // KEINE Dezimal-Normalisierung mehr im Frontend (Weg A)!
      if (!form.checkValidity()) {
        event.preventDefault();
        event.stopPropagation();
      }
      form.classList.add('was-validated');
    }, false);
  }
});
</script>
{% endblock %}