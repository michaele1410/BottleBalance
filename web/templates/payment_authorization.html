{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <h2 class="mb-4">{{ _('Zahlungsfreigabe') }}</h2>

  <!-- Aktionen -->
  <div class="d-flex flex-wrap gap-2 mb-3">
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#antragModal">
      <i class="bi bi-plus-lg me-1"></i> {{ _('Neuer Antrag') }}
    </button>
    <a href="{{ url_for('payment_routes.export_alle_antraege_pdf') }}" class="btn btn-outline-primary">
      <i class="bi bi-filetype-pdf me-1"></i> {{ _('Alle Anträge als PDF') }}
    </a>
    {% if 'payment:audit' in (ROLES.get(session.get('role'), [])) %}
    <a href="{{ url_for('payment_routes.zahlungsfreigabe_audit') }}" class="btn btn-outline-secondary">
      <i class="bi bi-clock-history me-1"></i> {{ _('Audit-Übersicht') }}
    </a>
    {% endif %}
  </div>

  <!-- Tabelle -->
  <div class="table-responsive">
    <table class="table table-bordered align-middle">
      <thead class="table-light">
        <tr>
          <th>{{ _('Antragsteller/in') }}</th>
          <th>{{ _('Datum') }}</th>
          <th>{{ _('Betrag') }}</th>
          <th>{{ _('Status') }}</th>
          <th class="text-nowrap">{{ _('Aktionen') }}</th>
        </tr>
      </thead>

      <tbody>
        {% for a in antraege %}
        <tr>
          <td colspan="5">
            <div class="mb-2">
              <strong>{{ _('Freigabe-Fortschritt') }}:</strong>
              {{ a.freigaben_count }} {{ _('von') }} {{ a.freigaben_gesamt }} {{ _('freigegeben') }}
              {% if a.approved_by_me %}
              • <i class="bi bi-person-check text-success"></i> {{ _('von dir') }}
              {% endif %}
            </div>
            <div class="progress" style="height: 20px;">
              <div class="progress-bar" role="progressbar" style="width: {{ a.freigabe_prozent }}%;"
                aria-valuenow="{{ a.freigaben_count }}" aria-valuemin="0" aria-valuemax="{{ a.freigaben_gesamt }}">
                {{ a.freigaben_count }} / {{ a.freigaben_gesamt }}
              </div>
            </div>

          </td>
        </tr>

        <tr>
          <td>{{ a.antragsteller }}</td>
          <td>{{ a.datum }}</td>
          <td>{{ a.betrag }} €</td>
          <td>
            <span class="badge badge-status-{{ a.status|replace(' ', '_') }}">{{ a.status }}</span>
          </td>
          <td class="text-nowrap">

            <!-- Details -->
            <a href="{{ url_for('payment_routes.zahlungsfreigabe_detail', antrag_id=a.id) }}"
              class="btn btn-sm btn-outline-secondary">
              {{ _('Details') }}
            </a>

            {% if a.can_freigeben %}
            <form method="post" action="{{ url_for('payment_routes.freigeben_antrag', antrag_id=a.id) }}"
              style="display:inline">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button class="btn btn-sm btn-success">{{ _('Freigeben') }}</button>
            </form>
            {% endif %}

            {% if a.can_freigabe_zurueckziehen %}
            <form method="post" action="{{ url_for('payment_routes.freigabe_zurueckziehen', antrag_id=a.id) }}"
              style="display:inline">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button class="btn btn-sm btn-warning">{{ _('Freigabe zurückziehen') }}</button>
            </form>
            {% endif %}

            <!--{% if a.can_on_hold %}
            <form method="post" action="{{ url_for('payment_routes.on_hold_antrag', antrag_id=a.id) }}" style="display:inline">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button class="btn btn-sm btn-outline-warning">On hold</button>
            </form>
            {% endif %}

            {% if has_endpoint('fortsetzen_antrag') and a.can_fortsetzen %}
            <form method="post" action="{{ url_for('payment_routes.fortsetzen_antrag', antrag_id=a.id) }}" style="display:inline">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button class="btn btn-sm btn-outline-primary">Fortsetzen</button>
            </form>
            {% endif %}-->
            {% if a.can_on_hold %}
            <form method="post" action="{{ url_for('payment_routes.on_hold_antrag', antrag_id=a.id) }}"
              style="display:inline">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button class="btn btn-sm btn-outline-warning">{{ _('On Hold') }}</button>
            </form>
            {% endif %}

            {% if a.can_fortsetzen %}
            <form method="post" action="{{ url_for('payment_routes.fortsetzen_antrag', antrag_id=a.id) }}"
              style="display:inline">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button class="btn btn-sm btn-outline-primary">{{ _('Fortsetzen') }}</button>
            </form>
            {% endif %}


            {% if a.can_abschliessen %}
            <form method="post" action="{{ url_for('payment_routes.abschliessen_antrag', antrag_id=a.id) }}"
              style="display:inline">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button class="btn btn-sm btn-primary">{{ _('Abschließen') }}</button>
            </form>
            {% endif %}

            {% if a.can_ablehnen %}
            <!-- Einfaches Inline-Ablehnen mit Grund -->
            <form method="post" action="{{ url_for('payment_routes.ablehnen_antrag', antrag_id=a.id) }}"
              style="display:inline" onsubmit="return confirm('{{ _('Ablehnen') }}?');">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <input type="hidden" name="grund" value="Abgelehnt (kurzbegründet)">
              <!-- ersetze bei Bedarf durch Modal -->
              <button class="btn btn-sm btn-outline-danger">{{ _('Ablehnen') }}</button>
            </form>
            {% endif %}

            {% if a.can_zurueckziehen %}
            <form method="post" action="{{ url_for('payment_routes.zurueckziehen_antrag', antrag_id=a.id) }}"
              style="display:inline" onsubmit="return confirm('{{ _('Antrag zurückziehen') }}?');">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button class="btn btn-sm btn-outline-secondary">{{ _('Zurückziehen') }}</button>
            </form>
            {% endif %}

            {% if a.can_loeschen and a.status not in ['abgeschlossen', 'abgelehnt', 'freigegeben'] %}
            <form method="post" action="{{ url_for('payment_routes.loeschen_antrag', antrag_id=a.id) }}"
              style="display:inline" onsubmit="return confirm('{{ _('Antrag endgültig löschen') }}?');">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button class="btn btn-sm btn-danger">{{ _('Löschen') }}</button>
            </form>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Modal: Ablehnen -->
<div class="modal fade" id="ablehnenModal" tabindex="-1" aria-labelledby="ablehnenModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form method="post" id="ablehnenForm">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="ablehnenModalLabel">{{ _('Antrag ablehnen') }}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Schließen"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <div class="mb-3">
            <label class="form-label">{{ _('Begründung (Pflicht)') }}</label>
            <textarea class="form-control" name="grund" required rows="4"
              placeholder="{{ _('Bitte Ablehnungsgrund angeben') }}."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">{{ _('Abbrechen') }}</button>
          <button class="btn btn-danger" type="submit">{{ _('Ablehnen') }}</button>
        </div>
      </div>
    </form>
  </div>
</div>

<script>
  const ablehnenModal = document.getElementById('ablehnenModal');
  ablehnenModal.addEventListener('show.bs.modal', (event) => {
    const button = event.relatedTarget;
    const antragId = button.getAttribute('data-antrag-id');
    const form = document.getElementById('ablehnenForm');
    form.action = "{{ url_for('payment_routes.ablehnen_antrag', antrag_id=0) }}".replace('/0', '/' + antragId);
  });
</script>

<!-- Modal: Neuer Antrag -->
<div class="modal fade" id="antragModal" tabindex="-1" aria-labelledby="antragModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form method="post" action="{{ url_for('payment_routes.zahlungsfreigabe_antrag') }}" id="antragForm"
      class="needs-validation" novalidate>
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="antragModalLabel">{{ _('Neuen Zahlungsantrag erstellen') }}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Schließen"></button>
        </div>

        <div class="modal-body">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

          <div class="mb-3">
            <label class="form-label">{{ _('Paragraph (optional)') }}</label>
            <input type="text" name="paragraph" class="form-control" placeholder="{{ _('z. Bsp. 3a') }}" value="$ 14 Abs. 2">
          </div>

          <div class="mb-3">
            <label class="form-label">{{ _('Verwendungszweck') }}</label>
            <input type="text" name="zweck" class="form-control" placeholder="{{ _('Wofür ist die Zahlungsanfrage') }}?">
          </div>

          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">{{ _('Datum') }}</label>              
              <input type="date" name="datum" class="form-control" required value="{{ today.strftime('%Y-%m-%d') }}">

              <div class="invalid-feedback">{{ _('Bitte ein Datum angeben') }}.</div>
            </div>
            <div class="col-md-6">
              <label class="form-label">{{ _('Betrag') }}</label>
              <div class="input-group">
                <input type="text" name="betrag" class="form-control" inputmode="decimal" placeholder="{{ _('z. Bsp. 49,90') }}"
                  required>
                <span class="input-group-text">{{ _('waehrung') }}</span>
                <div class="invalid-feedback">{{ _('Bitte einen Betrag angeben') }}.</div>
              </div>
              <small class="form-text text-muted">{{ _('Komma oder Punkt als Dezimaltrenner ist möglich') }}.</small>
            </div>
          </div>

          <div class="mb-3 mt-3">
            <label class="form-label">{{ _('Lieferant (optional)') }}</label>
            <input type="text" name="lieferant" class="form-control" placeholder="{{ _('Firma / Händler') }}">
          </div>

          <div class="mb-3">
            <label class="form-label">{{ _('Begründung (optional)') }}</label>
            <textarea name="begruendung" rows="3" class="form-control"
              placeholder="{{ _('Weshalb ist die Zahlungsanfrage notwendig') }}?"></textarea>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">{{ _('Abbrechen') }}</button>
          <button class="btn btn-primary" type="submit">
            <i class="bi bi-check-lg me-1"></i> {{ _('Anlegen') }}
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<script>
  // Bootstrap-Client-Validation aktivieren (optional)
  (() => {
    const form = document.getElementById('antragForm');
    form?.addEventListener('submit', (e) => {
      if (!form.checkValidity()) {
        e.preventDefault();
        e.stopPropagation();
      }
      form.classList.add('was-validated');
    }, false);
  })();

  // Formular beim Schließen zurücksetzen (optional)
  document.getElementById('antragModal')?.addEventListener('hidden.bs.modal', () => {
    const form = document.getElementById('antragForm');
    if (form) {
      form.reset();
      form.classList.remove('was-validated');
    }
  });
</script>

{% endblock %}