{% extends "base.html" %}
{% block content %}


<div class="row g-3 mb-4">
  <!-- Inventar -->
  <div class="col-6 col-md-4">
    <div class="card shadow-sm h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span>{{ _('Inventar:') }}</span>
        <span class="badge bg-primary">{{ inv_aktuell }} {{ _('Fl.') }}</span>
      </div>
      <div class="card-body sparkline-container">
        <div class="ratio sparkline-ratio">
          <canvas id="sparklineInv"></canvas>
        </div>
      </div>
    </div>
  </div>

<!-- Kassenbestand -->
  <div class="col-6 col-md-4">
    <div class="card shadow-sm h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span>{{ _('Kasse:') }}</span>
        <span class="badge bg-success">{{ format_eur_de(kas_aktuell) }}</span>
      </div>
      <div class="card-body sparkline-container">
        <div class="ratio sparkline-ratio">
          <canvas id="sparklineKas"></canvas>
        </div>
      </div>
    </div>
  </div>

<!-- Formular für neuen Datensatz -->

{% if can_add %}
  <div class="col-12 col-md-4">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <h2 class="h6 mb-3">{{ _('Neuen Datensatz hinzufügen') }}</h2>
        <form method="post" action="{{ url_for('add') }}" id="transaction-form" novalidate>
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <!-- Datum -->
        <div class="form-floating mb-3">
          <input type="text" name="datum" id="datum" class="form-control" placeholder="Datum" value="{{ default_date }}" required autofocus>
          <label for="datum">{{ _('Datum') }}</label>
        </div>

        <!-- Vollgut -->
        <div class="form-floating mb-3">
          <input id="vollgut" name="vollgut" type="number" inputmode="numeric" min="0" step="1" class="form-control" placeholder="0" autocomplete="off">
          <label for="vollgut">{{ _('Vollgut') }}</label>
        </div>

        <!-- Leergut -->
        <div class="form-floating mb-3">
          <input id="leergut" name="leergut" type="number" inputmode="numeric" min="0" step="1" class="form-control" placeholder="0" autocomplete="off">
          <label for="leergut">{{ _('Leergut') }}</label>
        </div>

        <!-- Einnahme -->
        <div class="input-group mb-3">
        <span class="input-group-text">{{ _('waehrung') }}</span>
        <div class="form-floating flex-grow-1">
            <input name="einnahme" type="number" step="0.01" inputmode="decimal" class="form-control" placeholder="0.00" id="einnahme" autocomplete="off">
            <label for="einnahme">{{ _('Einnahme') }}</label>
          </div>
        </div>

        <!-- Ausgabe -->
        <div class="input-group mb-3">
          <span class="input-group-text">{{ _('waehrung') }}</span>
          <div class="form-floating flex-grow-1">
              <input name="ausgabe" type="number" step="0.01" inputmode="decimal" class="form-control" placeholder="0.00" id="ausgabe" autocomplete="off">
              <label for="ausgabe">{{ _('Ausgabe') }}</label>
            </div>
        </div>

        <!-- Bemerkung -->
        <div class="form-floating mb-3">
          <input id="bemerkung" name="bemerkung" class="form-control" maxlength="500" placeholder="{{ _('Notiz') }}">
          <label for="bemerkung">{{ _('Bemerkung') }}</label>
        </div>

        <!-- Upload -->
        <input type="hidden" name="temp_token" id="temp_token" value="{{ temp_token }}">

        <div class="d-flex gap-2">
          <!-- Hinzufügen -->
          <button type="submit" class="btn btn-success flex-grow-1" disabled>
            <i class="bi-plus-lg me-1"></i> {{ _('Hinzufügen') }}
          </button>


          <!-- Upload-Button mit Badge -->
          <button type="button"
          class="btn btn-outline-primary position-relative"
          data-bs-toggle="modal"
          data-bs-target="#uploadModal"
          id="uploadBtn"
          aria-label="{{ _('Temporäre Anhänge hochladen') }}"
          title="{{ _('Temporäre Anhänge hochladen') }}">
            <i class="bi-upload me-1"></i> {{ _('Upload') }}
          </button>

        </div>
        </form>
      </div>
    </div>
  </div>
  {% endif %}
</div>

<!-- Tabelle -->
<div class="card shadow-sm">
  <div class="card-body">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2 mb-3">
      <h2 class="h5 m-0">{{ _('Einträge') }}</h2>

      <!-- Filter -->
      <form method="get" class="row g-2 align-items-end w-100 w-md-auto">
        <div class="col-12 col-md-3">
          <label class="form-label">{{ _('Suche') }}</label>
          <input type="text" name="q" class="form-control" placeholder="{{ _('Datum/Bemerkung') }}" value="{{ request.args.get('q','') }}">
        </div>
        <div class="col-6 col-md-2">
          <label class="form-label">{{ _('Von') }}</label>
          <input type="date" name="from" class="form-control" value="{{ request.args.get('from','') }}">
        </div>
        <div class="col-6 col-md-2">
          <label class="form-label">{{ _('Bis') }}</label>
          <input type="date" name="to" class="form-control" value="{{ request.args.get('to','') }}">
        </div>

        <!-- Toggle für Anhänge -->
        <div class="col-12 mt-2">
          <div class="btn-group" role="group" aria-label="Filter Anhänge">
            <!-- Alle -->
            <input type="radio"
                  class="btn-check"
                  name="attachments"
                  id="att-all"
                  value=""
                  autocomplete="off"
                  {% if not request.args.get('attachments') %}checked{% endif %}>
            <label class="btn btn-outline-secondary position-relative"
                  for="att-all"
                  title="{{ _('Alle') }}"
                  aria-label="{{ _('Alle') }}">
              <i class="bi-list"></i>
            </label>

            <!-- Nur mit Anhang -->
            <input type="radio"
                  class="btn-check"
                  name="attachments"
                  id="att-only"
                  value="only"
                  autocomplete="off"
                  {% if request.args.get('attachments') == 'only' %}checked{% endif %}>
            <label class="btn btn-outline-secondary position-relative"
                  for="att-only"
                  title="{{ _('Nur mit Anhang') }}"
                  aria-label="{{ _('Nur mit Anhang') }}">
              <i class="bi-paperclip"></i>
            </label>

            <!-- Ohne Anhang -->
            <input type="radio"
                  class="btn-check"
                  name="attachments"
                  id="att-none"
                  value="none"
                  autocomplete="off"
                  {% if request.args.get('attachments') == 'none' %}checked{% endif %}>
            <label class="btn btn-outline-secondary position-relative"
                  for="att-none"
                  title="{{ _('Ohne Anhang') }}"
                  aria-label="{{ _('Ohne Anhang') }}">
              <i class="bi-paperclip"></i>
              <i class="bi-slash"></i>
            </label>
          </div>
        </div>

        <div class="col-12 col-md-auto mt-2 mt-md-0">
          <div class="d-flex flex-row flex-wrap gap-2 align-items-center">
            <button class="btn btn-outline-primary" type="submit">
              <i class="bi-search me-1"></i> {{ _('Filtern') }}
            </button>
            <a class="btn btn-outline-secondary" href="{{ url_for('index') }}">
              <i class="bi-x-circle me-1"></i> {{ _('Zurücksetzen') }}
            </a>
          </div>
        </div>
      </form>

      <!-- Export -->
      <div class="col-12 col-md-auto">
        <div class="d-flex flex-row flex-wrap gap-2 align-items-center">
          {% if can_export_pdf %}
            <a class="btn btn-outline-danger"
              href="{{ url_for('export_pdf') }}?{% if request.args.get('q') %}q={{ request.args.get('q')|urlencode }}{% endif %}{% if request.args.get('from') %}{% if request.args.get('q') %}&{% endif %}from={{ request.args.get('from')|urlencode }}{% endif %}{% if request.args.get('to') %}{% if request.args.get('q') or request.args.get('from') %}&{% endif %}to={{ request.args.get('to')|urlencode }}{% endif %}{% if request.args.get('attachments') %}{% if request.args.get('q') or request.args.get('from') or request.args.get('to') %}&{% endif %}attachments={{ request.args.get('attachments')|urlencode }}{% endif %}">
              <i class="bi-file-earmark-pdf me-1"></i> PDF
            </a>
          {% endif %}
          {% if can_export_csv %}
          <a class="btn btn-outline-primary"
            href="{{ url_for('export_csv') }}?{% if request.args.get('q') %}q={{ request.args.get('q')|urlencode }}{% endif %}{% if request.args.get('from') %}{% if request.args.get('q') %}&{% endif %}from={{ request.args.get('from')|urlencode }}{% endif %}{% if request.args.get('to') %}{% if request.args.get('q') or request.args.get('from') %}&{% endif %}to={{ request.args.get('to')|urlencode }}{% endif %}{% if request.args.get('attachments') %}{% if request.args.get('q') or request.args.get('from') or request.args.get('to') %}&{% endif %}attachments={{ request.args.get('attachments')|urlencode }}{% endif %}">
            <i class="bi-download me-1"></i> CSV
          </a>
          {% endif %}
          <!-- Import -->
          {% if can_import %}
              <!--details>
                <summary style="cursor:pointer; font-weight:600;">
                  {{ _('CSV Import') }}
                </summary>
                <div style="margin-top: .75rem;">
                  <form action="{{ url_for('import_preview') if IMPORT_USE_PREVIEW else url_for('import_csv') }}" method="post" enctype="multipart/form-data" style="display:grid; gap:.5rem; grid-template-columns: 1fr auto;">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div>
                      <label for="csvFile" style="display:block; font-weight:600; margin-bottom:.25rem;">{{ _('CSV-Datei auswählen') }}</label>
                      <input id="csvFile" name="file" type="file" accept=".csv,text/csv" required
                            style="width:100%; padding:.375rem .5rem; border:1px solid #ced4da; border-radius:.25rem;">
                      <small style="color:#6c757d;">
                        {{ _("Erwartete Header:") }} <code>Datum;Vollgut;Leergut;Inventar;Einnahme;Ausgabe;Kassenbestand;Bemerkung</code>
                        {{ _("oder Kurzform ohne Inventar/Kassenbestand.") }}
                      </small>
                    </div>

                    <div style="display:flex; flex-direction:column; justify-content:flex-end; gap:.25rem; min-width: 240px;">
                      <label style="display:flex; align-items:center; gap:.5rem; white-space:nowrap;">
                        <input type="checkbox" name="replace_all">
                        <span>{{ _('Bestehende Einträge komplett ersetzen') }}</span>
                      </label>

                      <button type="submit"
                              style="padding:.5rem .75rem; border:1px solid #0d6efd; background:#0d6efd; color:#fff; border-radius:.25rem; cursor:pointer;">
                        {{ _('Vorschau anzeigen') }}
                      </button>

                      <a href="{{ url_for('import_sample') }}" style="text-align:center; font-size:.9rem; color:#0d6efd; text-decoration:none;">
                        {{ _('Beispiel-CSV herunterladen') }}
                      </a>
                    </div>
                  </form>
                </div>
              </details-->
              <!-- CSV Import Button (öffnet Modal) -->
              <a class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#csvImportModal">
                <i class="bi-upload me-1"></i> CSV Import
              </a>
            {% endif %}
        </div>
      </div>
    </div>

    <!-- Tabelle -->
    <div class="table-responsive">
      <table class="table table-sm align-middle table-striped">
        <thead class="table-light">
          <tr>
            <th style="cursor:pointer;" onclick="sortTableByDate()">{{ _('Datum') }}<i class="bi bi-arrow-down-up"></i></th>
            <th>{{ _('Vollgut') }}</th>
            <th>{{ _('Leergut') }}</th>
            <th>{{ _('Inventar') }}</th>
            <th>{{ _('Einnahme') }}</th>
            <th>{{ _('Ausgabe') }}</th>
            <th>{{ _('Kassenbestand') }}</th>
            <th>{{ _('Bemerkung') }}</th>
            <th class="text-end">{{ _('Aktionen') }}</th>
          </tr>
        </thead>
        <tbody>
        {% for e in entries %}
          <tr>
            <td>{{ format_date_de(e.datum) }}</td>
            <td>{{ e.vollgut }}</td>
            <td>{{ e.leergut }}</td>
            <td>{{ e.inventar }}</td>
            <td>{{ format_eur_de(e.einnahme) }}</td>
            <td>{{ format_eur_de(e.ausgabe) }}</td>
            <td>{{ format_eur_de(e.kassenbestand) }}</td>
            <td>{{ e.bemerkung }}</td>
            <td class="text-end">
              <!-- Bearbeiten -->
              <a class="btn btn-sm btn-outline-primary" href="{{ url_for('edit', entry_id=e.id) }}" title="{{ _('Bearbeiten') }}">
                <i class="bi-pencil-square"></i>
              </a>
              
              <!-- Dokumente öffnen (mit Badge) -->
              <button class="btn btn-sm btn-outline-secondary position-relative" type="button"
                      onclick="openAttachments({{ e.id }})" title="{{ _('Dokumente öffnen') }}">
                <i class="bi-paperclip"></i>
                {% if e.attachment_count and e.attachment_count > 0 %}
                  <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-secondary">
                    {{ e.attachment_count }}
                  </span>
                {% endif %}
              </button>

              <!-- Löschen -->
              <form method="post" action="{{ url_for('delete', entry_id=e.id) }}" class="d-inline"
                    onsubmit="return confirm('{{ _('Eintrag wirklich löschen?') }}');">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button class="btn btn-sm btn-outline-danger" title="{{ _('Löschen') }}">
                  <i class="bi-trash"></i>
                </button>
              </form>
            </td>
          </tr>
        {% else %}
          <tr><td colspan="9" class="text-center text-muted">{{ _('Keine Einträge vorhanden.') }}</td></tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- CSV Import Modal -->
<div class="modal fade" id="csvImportModal" tabindex="-1" aria-labelledby="csvImportModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form action="{{ url_for('import_preview') if IMPORT_USE_PREVIEW else url_for('import_csv') }}" method="post" enctype="multipart/form-data">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="modal-header">
          <h5 class="modal-title" id="csvImportModalLabel">{{ _('CSV-Datei importieren') }}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Schließen') }}"></button>
        </div>
        <div class="modal-body bg-light p-3 rounded shadow-sm">
          <div class="mb-3">
            <label for="csvFile" class="form-label">{{ _('CSV-Datei auswählen') }}</label>
            <input id="csvFile" name="file" type="file" accept=".csv,text/csv" required class="form-control" placeholder="CSV-Datei auswählen">
            <small class="form-text text-muted">
              {{ _("Erwartete Header:") }} <code>Datum;Vollgut;Leergut;Inventar;Einnahme;Ausgabe;Kassenbestand;Bemerkung</code>
              {{ _("oder Kurzform ohne Inventar/Kassenbestand.") }}
            </small>
          </div>
          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" name="replace_all" id="replaceAll">
            <label class="form-check-label" for="replaceAll">
              {{ _('Bestehende Einträge komplett ersetzen') }}
            </label>
          </div>
        </div>
        <div class="modal-footer d-flex justify-content-between">
          <a href="{{ url_for('import_sample') }}" class="btn btn-link">{{ _('Beispiel-CSV herunterladen') }}</a>
          <button type="submit" class="btn btn-primary">{{ _('Vorschau anzeigen') }}</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- NEU: Attachments Modal -->
<div class="modal fade" id="attachmentsModal" tabindex="-1" aria-labelledby="attachmentsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-md">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="attachmentsModalLabel">{{ _('Anhänge') }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Schließen') }}"></button>
      </div>
      <div class="modal-body">
        <ul id="attachmentsList" class="list-group"></ul>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Schließen') }}</button>
      </div>
    </div>
  </div>
</div>

<!-- Upload-Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="uploadModalLabel">{{ _('Anhänge hochladen') }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Schließen') }}"></button>
      </div>

      <div class="modal-body">
        <div class="input-group mb-2">
          <input class="form-control" type="file" id="add_temp_files" multiple
                 accept=".pdf,.png,.jpg,.jpeg,.gif,.webp,.heic,.heif,.svg,.txt,.csv,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.xml,.json">
          <button class="btn btn-outline-primary" type="button" id="btnTempUpload">
            <i class="bi-upload me-1"></i> {{ _('Hochladen') }}
          </button>
        </div>
        <div class="form-text">
          {{ _('Zulässige Formate:') }} PDF, Bilder, Office, Text. {{ _('Mehrere Dateien möglich.') }}
        </div>

        <ul id="addTempAttachmentsList" class="list-group mt-3"></ul>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Schließen') }}</button>
      </div>
    </div>
  </div>
</div>
<div class="toast-container position-fixed top-0 end-0 p-3" id="bbToastContainer"></div>


{% endblock %}

{% block scripts %}
<script>
function showToast(message, variant = 'danger') {
  // variant: 'primary'|'success'|'warning'|'danger'|...
  const container = document.getElementById('bbToastContainer');
  if (!container) return alert(message); // Fallback

  const toastEl = document.createElement('div');
  toastEl.className = `toast align-items-center text-bg-${variant} border-0`;
  toastEl.setAttribute('role', 'alert');
  toastEl.setAttribute('aria-live', 'assertive');
  toastEl.setAttribute('aria-atomic', 'true');
  toastEl.innerHTML = `
    <div class="d-flex">
      <div class="toast-body">${message}</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>`;
  container.appendChild(toastEl);
  const toast = new bootstrap.Toast(toastEl, { delay: 4000 });
  toast.show();
  toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
}


(function () {
  // Daten aus Flask
  const labelsRaw = {{ entries|map(attribute='datum')|list|tojson }};
  const dataInv   = {{ series_inv|tojson }};
  const dataKas   = {{ series_kas|tojson }};

  const labels = labelsRaw.map(d => {
    try { return new Date(d).toLocaleDateString('de-DE'); } catch { return String(d); }
  });

  const css          = getComputedStyle(document.documentElement);
  const colorPrimary = (css.getPropertyValue('--bs-primary') || '#0d6efd').trim();
  const colorSuccess = (css.getPropertyValue('--bs-success') || '#198754').trim();
  const gridColor    = (css.getPropertyValue('--bs-border-color') || '#dee2e6').trim();

  const baseOptions = {
    responsive: true,
    maintainAspectRatio: false,
    interaction: { intersect: false, mode: 'index' },
    plugins: {
      legend: { display: false },
      tooltip: {
        callbacks: {
          title: (items) => items[0]?.label ?? '',
          label: (ctx) => {
            const val = ctx.parsed.y;
            if (ctx.dataset.label === 'Kassenbestand') {
              return new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' }).format(val);
            }
            return `${val} {{ _('Flaschen') }}`;
          }
        }
      }
    },
    scales: {
      x: { display: false, grid: { display: false } },
      y: { display: false, grid: { color: gridColor } }
    }
  };

  function makeGradient(ctx, baseColor) {
    const g = ctx.createLinearGradient(0, 0, 0, ctx.canvas.height || 80);
    g.addColorStop(0, baseColor + '33');
    g.addColorStop(1, baseColor + '00');
    return g;
  }

  const invCanvas = document.getElementById('sparklineInv');
  if (invCanvas && window.Chart) {
    const invCtx = invCanvas.getContext('2d');
    new Chart(invCtx, {
      type: 'line',
      data: { labels, datasets: [{ label: 'Inventar', data: dataInv, borderColor: colorPrimary, backgroundColor: makeGradient(invCtx, colorPrimary), borderWidth: 2, fill: true, tension: 0.35, pointRadius: 3, pointBackgroundColor: colorPrimary }] },
      options: baseOptions
    });
  }

  const kasCanvas = document.getElementById('sparklineKas');
  if (kasCanvas && window.Chart) {
    const kasCtx = kasCanvas.getContext('2d');
    new Chart(kasCtx, {
      type: 'line',
      data: { labels, datasets: [{ label: 'Kassenbestand', data: dataKas, borderColor: colorSuccess, backgroundColor: makeGradient(kasCtx, colorSuccess), borderWidth: 2, fill: true, tension: 0.35, pointRadius: 3, pointBackgroundColor: colorSuccess }] },
      options: baseOptions
    });
  }
})();
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('transaction-form');
  const orderIds = ['datum', 'vollgut', 'leergut', 'einnahme', 'ausgabe', 'bemerkung'];
  const fields = orderIds.map(id => document.getElementById(id) || form?.querySelector(`[name="${id}"]`)).filter(Boolean);

  // Auto-Tab
  function focusByOffset(currentEl, delta) {
    const idx = Number(currentEl?.dataset?.idx ?? -1);
    if (idx < 0) return;
    const next = fields[idx + delta];
    if (next) next.focus({ preventScroll: true });
  }
  fields.forEach((el, idx) => {
    el.dataset.idx = idx;
    el.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        focusByOffset(el, e.shiftKey ? -1 : 1);
      }
    });
    if (el.type === 'number') el.addEventListener('wheel', (e) => e.preventDefault(), { passive: false });
  });

  // Flatpickr
  function isDark() { return document.documentElement.getAttribute('data-bs-theme') === 'dark'; }
  function toggleCalendarDark(calEl, dark) { if (calEl) calEl.classList.toggle('flatpickr-dark', !!dark); }
  if (window.flatpickr) {
    if (flatpickr.l10ns?.de) flatpickr.localize(flatpickr.l10ns.de);
    const fp = flatpickr('#datum', {
      allowInput: true, dateFormat: 'd.m.Y', clickOpens: true, disableMobile: false,
      onClose: () => focusByOffset(document.getElementById('datum'), 1),
      onOpen: (s, d, i) => toggleCalendarDark(i.calendarContainer, isDark())
    });
    new MutationObserver(() => {
      const dark = isDark();
      document.querySelectorAll('.flatpickr-calendar').forEach(c => toggleCalendarDark(c, dark));
    }).observe(document.documentElement, { attributes: true, attributeFilter: ['data-bs-theme'] });
  }

  // Haptik
  function hapticFeedback() { if (navigator.vibrate) navigator.vibrate(10); }
  form?.querySelectorAll('input, textarea, select').forEach(el => el.addEventListener('focus', hapticFeedback));

  // Pflichtfelder-Gruppe
  const feldIds = ['einnahme', 'ausgabe', 'vollgut', 'leergut'];
  const felder = feldIds.map(id => document.getElementById(id)).filter(Boolean);
  function getNumericValue(el) {
    const raw = (el?.value ?? '').toString().trim().replace(',', '.');
    const val = parseFloat(raw);
    return Number.isFinite(val) ? val : 0;
  }
  function anyPositive() { return felder.some(el => getNumericValue(el) > 0); }

  function setInlineInvalid(on) {
    felder.forEach(el => { el.classList.toggle('is-invalid', on); el.setAttribute('aria-invalid', on ? 'true' : 'false'); });
    const ausgabeWrap = document.getElementById('ausgabe')?.closest('.input-group, .form-floating');
    if (on && ausgabeWrap && !ausgabeWrap.querySelector('.invalid-feedback')) {
      const fb = document.createElement('div');
      fb.className = 'invalid-feedback';
      fb.textContent = '{{ _("Bitte mindestens einen Wert bei Einnahme, Ausgabe, Vollgut oder Leergut angeben.") }}';
      (ausgabeWrap.parentElement || ausgabeWrap).appendChild(fb);
    }
  }
  function showGlobalError(msg) {
    const btnRow = form?.querySelector('.d-flex.gap-2') || form;
    let alert = form.querySelector('#globalFormError');
    if (!alert) {
      alert = document.createElement('div');
      alert.id = 'globalFormError';
      alert.className = 'alert alert-danger';
      alert.setAttribute('role', 'alert');
      alert.setAttribute('aria-live', 'assertive');
      btnRow.parentNode.insertBefore(alert, btnRow);
    }
    alert.textContent = msg;
    alert.classList.remove('d-none');
    alert.scrollIntoView({ behavior: 'smooth', block: 'center' });
    (felder[0] || form).focus({ preventScroll: true });
  }
  function clearGlobalError() {
    const alert = form?.querySelector('#globalFormError');
    if (alert) { alert.classList.add('d-none'); alert.textContent = ''; }
  }

  // Submit-Button deaktivieren bis >0
  const submitBtn = form?.querySelector('.btn.btn-success.flex-grow-1');
  function updateSubmit() {
    if (!submitBtn) return;
    const enabled = anyPositive();
    submitBtn.disabled = !enabled;
    submitBtn.setAttribute('aria-disabled', String(!enabled));
    submitBtn.title = enabled ? '' : '{{ _("Bitte mindestens einen Wert bei Einnahme, Ausgabe, Vollgut oder Leergut angeben.") }}';
  }

  feldIds.forEach(id => {
    const el = document.getElementById(id);
    el?.addEventListener('input', () => {
      if (anyPositive()) { setInlineInvalid(false); clearGlobalError(); }
      updateSubmit();
    });
    el?.addEventListener('change', updateSubmit);
  });
  updateSubmit();

  // Submit-Handler
  if (form) {

  // Safari/Back-Forward-Cache: Spinner entfernen, wenn Nutzer per "Zurück" auf die Seite kommt
  window.addEventListener('pageshow', (e) => {
    if (e.persisted) form.classList.remove('is-submitting');
    });

    form.addEventListener('submit', (event) => {
      if (!anyPositive()) {
        event.preventDefault(); event.stopPropagation();
        setInlineInvalid(true);
        showGlobalError('{{ _("Bitte mindestens einen Wert bei Einnahme, Ausgabe, Vollgut oder Leergut angeben.") }}');
        form.classList.add('was-validated');
        updateSubmit();
        return;
      }

      // Browser-Constraint-Validation
      if (!form.checkValidity()) {
        event.preventDefault(); event.stopPropagation();
        form.classList.add('was-validated');
        return;
      }

      // ✅ Alles ok: Spinner-Klasse setzen (wird serverseitig durch Redirect automatisch beendet)
      form.classList.add('is-submitting');
      form.classList.add('was-validated');
    }, false);
  }

  // Auto-Submit beim Wechsel der Anhänge-Toggles
    document.querySelectorAll('input[name="attachments"]').forEach(el => {
      el.addEventListener('change', () => {
        // Falls "Alle" (value="") gewählt ist, bleibt attachments="" – dein Server-Code
        // wertet nur 'only'/'none' aus; leeres value führt zu keiner Einschränkung.
        el.form?.submit();
      });
    });
  });
  </script>

<script>
function sortTableByDate() {
  const table = document.querySelector("table");
  const tbody = table.querySelector("tbody");
  const rows = Array.from(tbody.querySelectorAll("tr"));
  const isAsc = table.dataset.sortOrder !== "asc";
  table.dataset.sortOrder = isAsc ? "asc" : "desc";
  rows.sort((a, b) => {
    const dateA = new Date(a.cells[0].innerText.split(".").reverse().join("-"));
    const dateB = new Date(b.cells[0].innerText.split(".").reverse().join("-"));
    return isAsc ? dateA - dateB : dateB - dateA;
  });
  rows.forEach(row => tbody.appendChild(row));
}
</script>

<script>
async function openAttachments(entryId) {
  try {
    const resp = await fetch(`{{ url_for('attachments_list', entry_id=0) }}`.replace('0', entryId));
    if (!resp.ok) throw new Error('HTTP ' + resp.status);
    const list = await resp.json();

    const ul = document.getElementById('attachmentsList');
    ul.innerHTML = '';

    if (!list || list.length === 0) {
      ul.innerHTML = `<li class="list-group-item text-muted">{{ _('Keine Anhänge vorhanden.') }}</li>`;
      new bootstrap.Modal(document.getElementById('attachmentsModal')).show();
      return;
    }

    if (list.length === 1) {
      window.open(list[0].url, '_blank');
      return;
    }

    list.forEach(it => {
      const li = document.createElement('li');
      li.className = 'list-group-item d-flex justify-content-between align-items-center';

      const left = document.createElement('div');
      left.className = 'text-truncate';
      left.style.maxWidth = '70%';

      const icon = document.createElement('i');
      icon.className = 'bi-paperclip me-1';

      const nameSpan = document.createElement('span');
      nameSpan.textContent = it.name;

      left.append(icon, nameSpan);

      const openA = document.createElement('a');
      openA.className = 'btn btn-sm btn-outline-primary';
      openA.href = it.url;
      openA.target = '_blank';
      openA.textContent = "{{ _('Öffnen') }}";

      li.append(left, openA);
      ul.appendChild(li);
    });

    new bootstrap.Modal(document.getElementById('attachmentsModal')).show();
  } catch (e) {
    console.error(e);
    alert('Fehler beim Laden der Anhänge.');
  }
}
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const csrf = "{{ csrf_token() }}";
  const token = document.getElementById('temp_token')?.value || '';
  const listEl = document.getElementById('addTempAttachmentsList');
  const badge = document.getElementById('uploadBadge');
  const fileEl = document.getElementById('add_temp_files');
  const btnUp = document.getElementById('btnTempUpload');

  function toggleBtn() { if (btnUp) btnUp.disabled = !(fileEl?.files?.length > 0); }
  fileEl?.addEventListener('change', toggleBtn);
  toggleBtn();

  function updateBadge(count) {
    if (!badge) return;
    if (count > 0) { badge.textContent = count > 99 ? '99+' : String(count); badge.classList.remove('d-none'); }
    else { badge.classList.add('d-none'); }
  }

  async function refreshTempList() {
    if (!token || !listEl) return;
    const url = "{{ url_for('attachments_temp_list', token='__T__') }}".replace('__T__', token);
    const resp = await fetch(url, { credentials: 'same-origin' });
    if (!resp.ok) return;
    const items = await resp.json();
    listEl.innerHTML = '';
    if (!items || items.length === 0) {
      listEl.innerHTML = `<li class="list-group-item text-muted">{{ _('Keine Anhänge vorhanden.') }}</li>`;
      updateBadge(0);
      return;
    }
    updateBadge(items.length);
    items.forEach(it => {
      const li = document.createElement('li');
      li.className = 'list-group-item d-flex justify-content-between align-items-center';
      const left = document.createElement('div');
      left.className = 'text-truncate'; left.style.maxWidth = '70%';
      const icon = document.createElement('i'); icon.className = 'bi-paperclip me-1';
      const nameSpan = document.createElement('span'); nameSpan.textContent = it.name;
      left.append(icon, nameSpan);
      const actions = document.createElement('div'); actions.className = 'd-flex gap-2';
      const openA = document.createElement('a'); openA.className = 'btn btn-sm btn-outline-primary'; openA.href = it.url; openA.target = '_blank'; openA.textContent = "{{ _('Öffnen') }}";
      const delBtn = document.createElement('button'); delBtn.className = 'btn btn-sm btn-outline-danger'; delBtn.dataset.id = it.id; delBtn.textContent = "{{ _('Löschen') }}";
      delBtn.addEventListener('click', async (ev) => {
        ev.preventDefault();
        if (!confirm('{{ _("Anhang wirklich löschen?") }}')) return;
        const attId = delBtn.dataset.id;
        await fetch(`{{ url_for('attachments_temp_delete', att_id=0) }}`.replace('0', attId), { method: 'POST', headers: { 'X-CSRF-Token': "{{ csrf_token() }}" }, credentials: 'same-origin' });
        refreshTempList();
      });
      actions.append(openA, delBtn);
      li.append(left, actions);
      listEl.appendChild(li);
    });
  }

  const uploadModalEl = document.getElementById('uploadModal');
  if (uploadModalEl) uploadModalEl.addEventListener('shown.bs.modal', refreshTempList);

  btnUp?.addEventListener('click', async () => {
    if (!token || !fileEl || !fileEl.files?.length) return;
    for (const f of fileEl.files) {
      const fd = new FormData();
      fd.append('files', f);
      fd.append('csrf_token', csrf);
      const url = "{{ url_for('attachments_temp_upload', token='__T__') }}".replace('__T__', token);
      const resp = await fetch(url, { method: 'POST', body: fd, credentials: 'same-origin' });
      if (!resp.ok) { alert(await resp.text() || 'Upload fehlgeschlagen'); break; }
    }
    fileEl.value = '';
    refreshTempList();
  });

  refreshTempList();
});
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // ... dein bestehender Code ...

  // Auto-Submit beim Wechsel der Anhänge-Toggles
  document.querySelectorAll('input[name="attachments"]').forEach(el => {
    el.addEventListener('change', () => {
      // Falls "Alle" (value="") gewählt ist, bleibt attachments="" – dein Server-Code
      // wertet nur 'only'/'none' aus; leeres value führt zu keiner Einschränkung.
      el.form?.submit();
    });
  });
});
</script>

{% endblock %}