
{% extends "base.html" %}
{% block content %}
<div class="row g-3 mb-4">
  <div class="col-12 col-lg-4">
    <div class="p-3 bg-light rounded-3 h-100">
      <div class="mb-1"><strong>{{ _('Inventar (aktuell):') }}</strong> <span class="fs-5 ms-1">{{ inv_aktuell }}</span> {{ _('Flaschen') }}</div>
      <div><canvas id="sparkInv" height="40"></canvas></div>
      {% if request.args.get('from') or request.args.get('to') %}
      <div class="small text-muted mt-1">{{ _('Im Filter:') }} {{ filter_inv }} {{ _('Flaschen') }}</div>
      {% endif %}
    </div>
  </div>
  <div class="col-12 col-lg-4">
    <div class="p-3 bg-light rounded-3 h-100">
      <div class="mb-1"><strong>{{ _('Kassenbestand (aktuell):') }}</strong> <span class="fs-5 ms-1">{{ format_eur_de(kas_aktuell) }}</span></div>
      <div><canvas id="sparkKas" height="40"></canvas></div>
      {% if request.args.get('from') or request.args.get('to') %}
      <div class="small text-muted mt-1">{{ _('Im Filter:') }} {{ format_eur_de(filter_kas) }}</div>
      {% endif %}
    </div>
  </div>

  {% if can_add %}
  <div class="col-12 col-lg-4">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <h2 class="h6 mb-3">{{ _('Neuen Datensatz hinzufügen') }}</h2>
        <form method="post" action="{{ url_for('add') }}" class="row g-2">
          <div class="col-12">
            <label class="form-label">{{ _('Datum') }}</label>
            <input name="datum" id="datum" class="form-control" value="{{ default_date }}" placeholder="dd.MM.yyyy">
          </div>
          <div class="col-6">
            <label class="form-label">{{ _('Vollgut') }}</label>
            <input name="vollgut" type="number" step="1" class="form-control" placeholder="0">
          </div>
          <div class="col-6">
            <label class="form-label">{{ _('Leergut') }}</label>
            <input name="leergut" type="number" step="1" class="form-control" placeholder="0">
          </div>
          <div class="col-6">
            <label class="form-label">{{ _('Einnahme') }} {{ _('waehrung') }}</label>
            <input name="einnahme" type="number" step="0.01" inputmode="decimal"
                  class="form-control" placeholder="{{ _('z.B. 12,34') }}" id="einnahme">
          </div>

          <div class="col-6">
            <label class="form-label">{{ _('Ausgabe') }} {{ _('waehrung') }}</label>
            <input name="ausgabe" type="number" step="0.01" inputmode="decimal"
                  class="form-control" placeholder="{{ _('z.B. -5,00') }}" id="ausgabe">
          </div>
          </div>
          <div class="col-12">
            <label class="form-label">{{ _('Bemerkung') }}</label>
            <input name="bemerkung" class="form-control" maxlength="500" placeholder="{{ _('Notiz') }}">
          </div>
          <div class="col-12">
            <button class="btn btn-success w-100"><i class="bi-plus-lg me-1"></i> {{ _('Hinzufügen') }}</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  {% endif %}
</div>

<div class="card shadow-sm">
  <div class="card-body">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2 mb-3">
      <h2 class="h5 m-0">{{ _('Einträge') }}</h2>
      <form method="get" class="row g-2 align-items-end w-100 w-md-auto">
        <div class="col-12 col-md-3">
          <label class="form-label">{{ _('Suche') }}</label>
          <input type="text" name="q" class="form-control" placeholder="{{ _('Datum/Bemerkung') }}" value="{{ request.args.get('q','') }}">
        </div>
        <div class="col-6 col-md-2">
          <label class="form-label">{{ _('Von') }}</label>
          <input type="date" name="from" class="form-control" value="{{ request.args.get('from','') }}">
        </div>
        <div class="col-6 col-md-2">
          <label class="form-label">{{ _('Bis') }}</label>
          <input type="date" name="to" class="form-control" value="{{ request.args.get('to','') }}">
        </div>
        <div class="col-12 col-md-auto">
          <div class="d-flex flex-row flex-wrap gap-2 align-items-center">
            <button class="btn btn-outline-primary" type="submit">
              <i class="bi-search me-1"></i> {{ _('Filtern') }}
            </button>
            <a class="btn btn-outline-secondary" href="{{ url_for('index') }}">
              <i class="bi-x-circle me-1"></i> {{ _('Zurücksetzen') }}
            </a>
          </div>
        </div>
      </form>
      <div class="col-12 col-md-auto">
        <div class="d-flex flex-row flex-wrap gap-2 align-items-center">
          {% if can_export_pdf %}
            <a class="btn btn-outline-danger" href="{{ url_for('export_pdf', q=request.args.get('q'), from=request.args.get('from'), to=request.args.get('to')) }}">
              <i class="bi-file-earmark-pdf me-1"></i> PDF
            </a>
            {% endif %}
            {% if can_export_csv %}
            <a class="btn btn-outline-primary" href="{{ url_for('export_csv', q=request.args.get('q'), from=request.args.get('from'), to=request.args.get('to')) }}">
              <i class="bi-download me-1"></i> CSV
            </a>
            {% endif %}
        </div>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-sm align-middle table-striped">
        <thead class="table-light">
          <tr>
            <th>{{ _('Datum') }}</th>
            <th>{{ _('Vollgut') }}</th>
            <th>{{ _('Leergut') }}</th>
            <th>{{ _('Inventar') }}</th>
            <th>{{ _('Einnahme') }}</th>
            <th>{{ _('Ausgabe') }}</th>
            <th>{{ _('Kassenbestand') }}</th>
            <th>{{ _('Bemerkung') }}</th>
            <th class="text-end">{{ _('Aktionen') }}</th>
          </tr>
        </thead>
        <tbody>
        {% for e in entries %}
          <tr>
            <td>{{ format_date_de(e.datum) }}</td>
            <td>{{ e.vollgut }}</td>
            <td>{{ e.leergut }}</td>
            <td>{{ e.inventar }}</td>
            <td>{{ format_eur_de(e.einnahme) }}</td>
            <td>{{ format_eur_de(e.ausgabe) }}</td>
            <td>{{ format_eur_de(e.kassenbestand) }}</td>
            <td>{{ e.bemerkung }}</td>
            <td class="text-end">
              <a class="btn btn-sm btn-outline-primary" href="{{ url_for('edit', entry_id=e.id) }}" title="Bearbeiten"><i class="bi-pencil-square"></i></a>
              <form method="post" action="{{ url_for('delete', entry_id=e.id) }}" class="d-inline" onsubmit="return confirm('{{ _('Datum') }}Eintrag wirklich löschen?');">
                <button class="btn btn-sm btn-outline-danger" title="Löschen"><i class="bi-trash"></i></button>
              </form>
            </td>
          </tr>
        {% else %}
          <tr><td colspan="9" class="text-center text-muted">{{ _('Keine Einträge vorhanden.') }}</td></tr>
        {% endfor %}
        </tbody>
      </table>
    </div>

  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  function sparkline(canvasId, data, color){
    const ctx = document.getElementById(canvasId);
    if(!ctx) return;

    // Farbverlauf für modernen Look
    const gradient = ctx.getContext('2d').createLinearGradient(0, 0, 0, 60);
    gradient.addColorStop(0, color + '88'); // halbtransparent
    gradient.addColorStop(1, color + '00'); // transparent

    new Chart(ctx, {
      type: 'line',
      data: {
        labels: data.map((_, i) => i + 1),
        datasets: [{
          data,
          borderColor: color,
          backgroundColor: gradient,
          pointRadius: 0,
          fill: true,
          tension: 0.4 // weichere Kurven
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: {
          duration: 1000,
          easing: 'easeOutQuart'
        },
        scales: {
          x: { display: false },
          y: { display: false }
        },
        plugins: {
          legend: { display: false },
          tooltip: {
            enabled: true,
            backgroundColor: '#fff',
            titleColor: '#333',
            bodyColor: '#333',
            borderColor: color,
            borderWidth: 1
          }
        },
        elements: {
          line: { borderWidth: 2 }
        }
      }
    });
  }
</script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const fields = ['einnahme', 'ausgabe'];

    fields.forEach(id => {
      const input = document.getElementById(id);
      let interval;
      let speed = 150; // Startgeschwindigkeit (ms)
      let holdTime = 0; // Dauer des Haltens in ms
      let increment = parseFloat(input.step) || 0.01;

      // Komma in Punkt umwandeln
      input.addEventListener('input', () => {
        input.value = input.value.replace(',', '.');
      });

      function getIncrement() {
        if (holdTime > 2000) return 1;    // ab 2s -> 1.00
        if (holdTime > 1000) return 0.1;  // ab 1s -> 0.10
        return 0.01;                      // Standard
      }

      function changeValue(direction) {
        increment = getIncrement();
        const current = parseFloat(input.value || 0);
        input.value = (current + direction * increment).toFixed(2);
      }

      function startChanging(direction) {
        holdTime = 0;
        changeValue(direction);
        interval = setInterval(() => {
          holdTime += speed;
          changeValue(direction);
          if (speed > 30) speed -= 10; // Beschleunigung
          clearInterval(interval);
          interval = setInterval(() => {
            holdTime += speed;
            changeValue(direction);
          }, speed);
        }, speed);
      }

      function stopChanging() {
        clearInterval(interval);
        speed = 150; // Reset Geschwindigkeit
        holdTime = 0;
      }

      // Tastatur ↑/↓ mit Beschleunigung
      let keyHeld = false;
      input.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowUp' || e.key === 'ArrowDown') {
          if (!keyHeld) {
            keyHeld = true;
            startChanging(e.key === 'ArrowUp' ? 1 : -1);
          }
          e.preventDefault();
        }
      });
      input.addEventListener('keyup', (e) => {
        if (e.key === 'ArrowUp' || e.key === 'ArrowDown') {
          keyHeld = false;
          stopChanging();
        }
      });
    });
  });
</script>

{% endblock %}
