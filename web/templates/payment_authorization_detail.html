{% extends "base.html" %}
{% block content %}
<div class="card shadow-sm">
  <div class="card-body">
    <!-- Payment request -->
    <dl class="row">
      
      <form method="post" action="{{ url_for('payment_routes.edit_payment_request', request_id=payment_request.id) }}">
        <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h5 mb-3">{{ _('Payment request') }} #{{ payment_request.id }} - {{ _('State') }}: <span class="badge badge-state-{{ payment_request.state|replace(' ', '_') }}">{{ payment_request.state }}</span></h1>
        
        <div class="d-flex gap-2">
          {% if payment_request.state not in ['approved', 'completed', 'rejected', 'withdrawn'] and approvals_done == 0 %}
          <button type="submit" class="btn btn-primary">{{ _('Save') }}</button>
          {% endif %}
          <a href="{{ url_for('payment_routes.export_single_request_pdf', request_id=payment_request.id) }}"
            class="btn btn-outline-danger">
            <i class="bi bi-filetype-pdf me-1 text-danger"></i> {{ _('PDF export') }}
          </a>
          <a href="{{ url_for('payment_routes.payment_requests') }}" class="btn btn-outline-secondary">{{ _('Back') }}</a>
        </div>

      </div>
        {% if payment_request.state not in ['approved', 'completed', 'rejected', 'withdrawn'] and approvals_done == 0 %}
        <div class="input-group mb-3">
          <span class="input-group-text"><i class="bi bi-person"></i></span>
          <div class="form-floating flex-grow-1">
            <input type="text" name="requestor"  inputmode="text" class="form-control"
              placeholder="{{ _('Requestor') }}" value="{{ payment_request.requestor or '' }}" readonly>
              <label for="requestor">{{ _('Requestor') }}</label>
          </div>
        </div>

        <div class="input-group mb-3">
          <span class="input-group-text"><i class="bi bi-calendar"></i></span>
          <div class="form-floating flex-grow-1">
            <input type="date" name="date" value="{{ payment_request.date|strftime('%Y-%m-%d') if payment_request.date else '' }}"
            class="form-control" readonly>
              <label for="date">{{ _('Date') }}</label>
          </div>
        </div>

        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="input-group mb-3">
          <span class="input-group-text"><i class="bi bi-text-paragraph"></i></span>
          <div class="form-floating flex-grow-1">
            <input type="text" name="paragraph"  inputmode="text" class="form-control"
              placeholder="{{ _('Paragraph') }}" value="{{ payment_request.paragraph or '' }}">
              <label for="paragraph">{{ _('Paragraph') }}</label>
          </div>
        </div>

        <div class="input-group mb-3">
          <span class="input-group-text"><i class="bi bi-chat-text"></i></span>
          <div class="form-floating flex-grow-1">
            <input type="text" name="purpose"  inputmode="text" class="form-control"
              placeholder="{{ _('Purpose') }}" value="{{ payment_request.purpose or '' }}">
              <label for="purpose">{{ _('Purpose') }}</label>
          </div>
        </div>

        <div class="input-group mb-3">
          <span class="input-group-text"><i class="bi bi-wallet2"></i></span>
          <div class="form-floating flex-grow-1">
            <input type="number" name="amount"  inputmode="decimal" inputmode="decimal" step="0.01" class="form-control"
              placeholder="0.00" value="{{ payment_request.amount or '' }}" autocomplete="off">
              <label for="amount">{{ _('Amount') }}</label>
          </div>
        </div>

        <div class="input-group mb-3">
          <span class="input-group-text"><i class="bi bi-building"></i></span>
          <div class="form-floating flex-grow-1">
            <input type="text" name="supplier"  inputmode="text" class="form-control"
              placeholder="{{ _('Supplier') }}" value="{{ payment_request.supplier or '' }}">
              <label for="supplier">{{ _('Supplier') }}</label>
          </div>
        </div>

         <div class="input-group mb-3">
          <span class="input-group-text"><i class="bi bi-chat-quote"></i></span>
          <div class="form-floating flex-grow-1">
            <input type="text" name="justification"  inputmode="text" class="form-control"
              placeholder="{{ _('Justification') }}" rows="3" value="{{ payment_request.justification or '' }}">
              <label for="justification">{{ _('Justification') }}</label>
          </div>
        </div>

        {% else %}
          <div class="input-group mb-3">
          <span class="input-group-text"><i class="bi bi-person"></i></span>
          <div class="form-floating flex-grow-1">
            <input type="text" name="requestor"  inputmode="text" class="form-control"
              placeholder="{{ _('Requestor') }}" value="{{ payment_request.requestor or '' }}" readonly>
              <label for="requestor">{{ _('Requestor') }}</label>
          </div>
        </div>

        <div class="input-group mb-3">
          <span class="input-group-text"><i class="bi bi-calendar"></i></span>
          <div class="form-floating flex-grow-1">
            <input type="text" name="date" inputmode="decimal" value="{{ payment_request.date|strftime('%Y-%m-%d') if payment_request.date else '' }}"
            class="form-control" readonly>
              <label for="date">{{ _('Date') }}</label>
          </div>
        </div>

        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

        <div class="input-group mb-3">
          <span class="input-group-text"><i class="bi bi-text-paragraph"></i></span>
          <div class="form-floating flex-grow-1">
            <input type="text" name="paragraph"  inputmode="text" class="form-control"
              placeholder="{{ _('Paragraph') }}" value="{{ payment_request.paragraph or '' }}" readonly>
              <label for="paragraph">{{ _('Paragraph') }}</label>
          </div>
        </div>
        
        <div class="input-group mb-3">
          <span class="input-group-text"><i class="bi bi-chat-text"></i></span>
          <div class="form-floating flex-grow-1">
            <input type="text" name="purpose"  inputmode="text" class="form-control"
              placeholder="{{ _('Purpose') }}" value="{{ payment_request.purpose or '' }}" readonly>
              <label for="purpose">{{ _('Purpose') }}</label>
          </div>
        </div>

        <div class="input-group mb-3">
          <span class="input-group-text"><i class="bi bi-cash"></i></span>
          <div class="form-floating flex-grow-1">
            <input type="number" name="amount"  inputmode="number" inputmode="decimal" class="form-control"
              placeholder="{{ _('Amount') }}" value="{{ payment_request.amount or '' }}" readonly>
              <label for="amount">{{ _('Amount') }}</label>
          </div>
        </div>

        <div class="input-group mb-3">
          <span class="input-group-text"><i class="bi bi-building"></i></span>
          <div class="form-floating flex-grow-1">
            <input type="text" name="supplier"  inputmode="text" class="form-control"
              placeholder="{{ _('Supplier') }}" value="{{ payment_request.supplier or '' }}" readonly>
              <label for="supplier">{{ _('Supplier') }}</label>
          </div>
        </div>

         <div class="input-group mb-3">
          <span class="input-group-text"><i class="bi bi-chat-quote"></i></span>
          <div class="form-floating flex-grow-1">
            <input type="text" name="justification"  inputmode="text" class="form-control"
              placeholder="{{ _('Justification') }}" value="{{ payment_request.justification or '' }}" readonly>
              <label for="justification">{{ _('Justification') }}</label>
          </div>
        </div>

        {% endif %}
      </form>
    </dl>

    <!-- PROGRESS BAR-->
    <h5 class="mt-5">{{ _('Approval progress') }}</h5>
    <div class="mb-2" style="max-width: 520px;">
      <div class="progress" style="height: 8px;">
        <div class="progress-bar bg-success" role="progressbar" style="width: {{ approval_percent }}%;"
          aria-valuenow="{{ approvals_done }}" aria-valuemin="0" aria-valuemax="{{ approvals_total }}"></div>
      </div>
      <small class="text-muted">{{ approvals_done }}/{{ approvals_total }} {{ _('Approvals') }}</small>
    </div>

    <!-- APPROVERS-->
    <h5 class="mt-5">{{ _('Chairmans') }}</h5>
    <div class="row row-cols-1 row-cols-md-2 g-2 mb-3" style="max-width: 720px;">
      {% for ap in approvers %}
      <div class="col">
        <div class="d-flex align-items-center gap-2 p-2 border rounded">
          {% if ap.approved %}
          <i class="bi bi-check-circle-fill text-success"></i>
          <span>{{ ap.username }}</span>
          <span class="badge bg-success-subtle text-success border border-success-subtle">{{ _('approved') }}</span>
          {% else %}
          <i class="bi bi-clock text-muted"></i>
          <span>{{ ap.username }}</span>
          <span class="badge bg-secondary-subtle text-secondary border border-secondary-subtle">{{ _('pending') }}</span>
          {% endif %}
        </div>
      </div>
      {% endfor %}
    </div>

    <!-- ATTACHMENTS-->
    <h5 class="mt-5">{{ _('Attachments') }}</h5>

    <!-- Upload-Form -->
    {% if payment_request.state not in ['completed', 'rejected', 'withdrawn'] %}
    <form action="{{ url_for('payment_routes.upload_payment_requests_attachment', request_id=payment_request.id) }}" method="post"
      enctype="multipart/form-data" class="mb-3">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <div class="input-group">
        <input class="form-control form-control-sm" type="file" name="files" multiple
          accept=".pdf,.png,.jpg,.jpeg,.gif,.webp,.heic,.heif,.svg,.txt,.csv,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.xml,.json">
        <button class="btn btn-outline-primary" type="submit">
          <i class="bi-upload me-1"></i> {{ _('Upload') }}
        </button>
      </div>
      <div class="form-text">
        {{ _('Acceptable formats:') }} PDF, Images, Office, Text. {{ _('Multiple files possible.') }}
      </div>
    </form>
    {% endif %}

    <!-- Audit list -->
    {% if attachments and attachments|length > 0 %}
    <ul class="list-group">
      {% for att in attachments %}
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <div>
          <a href="{{ url_for('payment_routes.download_payment_requests_attachment', att_id=att.id) }}" target="_blank">
            {{ att.original_name }}
          </a>
          <small class="text-muted ms-2">
            {{ (att.size_bytes or 0) // 1024 }} KB
            {% if att.created_at %} Â· {{ att.created_at.strftime('%d.%m.%Y %H:%M') }}{% endif %}
          </small>
          <a href="{{ url_for('payment_routes.view_payment_requests_attachment', att_id=att.id) }}" target="_blank"
            class="btn btn-sm btn-outline-primary">{{ _('View') }}</a>
        </div>
        {% if payment_request.state not in ['completed', 'rejected', 'withdrawn'] %}
        <form method="post" action="{{ url_for('payment_routes.delete_payment_requests_attachment', att_id=att.id) }}"
          onsubmit="return confirm('{{ _('Are you sure to delete the attachment?') }}');">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

          <button type="submit" class="btn btn-sm btn-outline-danger">{{ _('Delete') }}</button>
        </form>
        {% endif %}
      </li>
      {% endfor %}
    </ul>
    {% else %}
    <p class="text-muted">{{ _('No attachments available') }}.</p>
    {% endif %}

    <!-- AUDIT -->
    <h5 class="mt-5">{{ _('Audit history') }}</h5>
    <table class="table table-sm align-middle table-striped table-stacked table-bordered">
      <thead class="table-light">
        <tr>
          <th>{{ _('Time') }}</th>
          <th>{{ _('Action') }}</th>
          <th>{{ _('User') }}</th>
          <th>{{ _('Details') }}</th>
        </tr>
      </thead>
      <tbody>   
      {% for log in audit %}
          <tr>
            <td data-label="{{ _('Time') }}">{{ log.timestamp.strftime('%d.%m.%Y %H:%M:%S') if log.timestamp else '' }}</td>
            <td data-label="{{ _('Action') }}">{{ log.action }}</td>
            <td data-label="{{ _('User') }}">{{ log.username or 'Unknown' }}</td>
            <td data-label="{{ _('Details') }}">{{ (log.detail or '')|replace('\n','<br>')|safe }}</td>
          </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}