{% extends "base.html" %}
{% block content %}
<div class="card shadow-sm">
  <div class="card-body">
    <h1 class="h5 mb-3">{{ _('Settings') }}</h1>

    {# Flash-Messages #}
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div class="mb-3">
      {% for category, message in messages %}
      {% set bs = 'danger' if category in ['error','danger'] else (
        'warning' if category == 'warning' else (
        'success' if category == 'success' else 'info')) %}
      <div class="alert alert-{{ bs }} alert-dismissible fade show" role="alert">
        {{ message|safe }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="{{ _('Close') }}"></button>
      </div>
      {% endfor %}
    </div>
    {% endif %}
    {% endwith %}

    <div class="row g-4">
      {# ---------- Notes (full width) ---------- #}
      <div class="col-12">
        <div class="card shadow-sm">
          <div class="card-header d-flex justify-content-between align-items-center">
            {{ _('Manage notes') }}
            <span class="text-muted small">{{ _('One option per line') }}</span>
          </div>
          <div class="card-body">
            <div class="row g-3 align-items-start">
              <div class="col-md-5 order-2 order-md-1">
                <label class="form-label">{{ _('Current notes') }}</label>
                <ul class="list-group list-group-flush border rounded">
                  {% for opt in current_notes %}
                  <li class="list-group-item py-1">{{ opt }}</li>
                  {% else %}
                  <li class="list-group-item text-muted">{{ _('No notes available') }}</li>
                  {% endfor %}
                </ul>
              </div>
              <div class="col-md-7 order-1 order-md-2">
                <form method="post" action="{{ url_for('admin_tools') }}" class="h-100 d-flex flex-column">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <input type="hidden" name="action" value="update_notes">
                  <label for="options" class="form-label">{{ _('Replace notes') }}</label>
                  <textarea id="options" name="options" class="form-control" rows="10"
                    placeholder="{{ _('One option per line ...') }}">{{ current_notes|join('\n') }}</textarea>
                  <div class="mt-3 d-flex gap-2">
                    <button type="submit" class="btn btn-primary">
                      <i class="bi bi-save me-1"></i>{{ _('Save') }}
                    </button>
                    <button type="button" class="btn btn-outline-secondary"
                      onclick="document.getElementById('options').value='';">
                      <i class="bi bi-eraser me-1"></i>{{ _('Empty') }}
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>

      {# ---------- SMTP test and DB dump side by side ---------- #}
      <div class="col-md-6">
        <div class="card shadow-sm">
          <div class="card-header">
            {{ _('Check SMTP configuration') }}
          </div>
          <div class="card-body">
            <p class="mb-3">
              {% if state %}
              {% set s_lower = state|string|lower %}
              {% if 'incomplete' in s_lower %}
              <span class="badge bg-danger">{{ state }}</span>
              {% else %}
              <span class="badge bg-success">{{ state }}</span>
              {% endif %}
              {% else %}
              <span class="badge bg-secondary">{{ _('Unknown SMTP status') }}</span>
              {% endif %}
            </p>
            <form method="post" action="{{ url_for('admin_tools') }}">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <input type="hidden" name="action" value="smtp">
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-envelope-check me-1"></i>{{ _('Send test email') }}
              </button>
            </form>
            <small class="text-muted d-block mt-2">
              {{ _('The test email is sent to the configured SMTP user address.') }}
            </small>
          </div>
        </div>
      </div>

      <div class="col-md-6">
        <div class="card shadow-sm">
          <div class="card-header">
            {{ _('PostgreSQL database export') }}
          </div>
          <div class="card-body">
            <p class="text-muted">
              {{ _('Generates an SQL dump of the current database and makes it available for download.') }}
            </p>
            <form method="post" action="{{ url_for('admin_tools') }}">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <input type="hidden" name="action" value="dump">
              <button type="submit" class="btn btn-primary"
                onclick="return confirm('{{ _('Create dump now?') }}')">
                <i class="bi bi-download me-1"></i>{{ _('Create & download dump') }}
              </button>
            </form>
          </div>
        </div>
      </div>

      <!-- ---------- Branding: Upload custom logo ---------- -->
      <div class="col-12">
        <div class="card shadow-sm">
          <div class="card-header d-flex justify-content-between align-items-center">
            {{ _('Branding: Your own logo') }}
            <span class="text-muted small">{{ _('SVG, PNG, JPG, WEBP â€“ recommended: SVG or PNG') }}</span>
          </div>
          <div class="card-body">
            <div class="row g-3 align-items-start">
              <div class="col-md-6">
                <div class="mb-2">{{ _('Current logo (preview)') }}</div>
                <div class="border rounded p-2 d-flex align-items-center" style="min-height:64px">
                  <img src="{{ brand_logo_url }}" alt="Logo" style="max-height:48px">
                </div>
                <small class="text-muted d-block mt-2">
                  {{ _('If no custom logo is stored, the default logo will be used.') }}
                </small>
              </div>

              <div class="col-md-6">
                <!-- Upload-Form -->
                <form method="post"
                      action="{{ url_for('admin_tools') }}"
                      enctype="multipart/form-data"
                      class="d-flex flex-column gap-2">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <input type="hidden" name="action" value="branding_upload">

                  <label class="form-label" for="logo">{{ _('Select logo file') }}</label>
                  <input class="form-control" type="file" id="logo" name="logo"
                        accept="image/svg+xml,image/png,image/jpeg,image/webp" required>

                  <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary">
                      <i class="bi bi-upload me-1"></i> {{ _('Upload') }}
                    </button>
                  </div>

                  <small class="text-muted">
                    {{ _('Note: The logo is stored on the server side under uploads/branding/. ') }}
                    {{ _('Cache is updated automatically.') }}
                  </small>
                </form>

                <!-- Remove form as siblings, not within the upload form -->
                <form method="post"
                      action="{{ url_for('admin_tools') }}"
                      class="mt-2 d-inline">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <input type="hidden" name="action" value="branding_remove">
                  <button type="submit"
                          class="btn btn-outline-danger"
                          onclick="return confirm('{{ _('Remove your own logo?') }}')">
                    <i class="bi bi-trash me-1"></i> {{ _('Remove') }}
                  </button>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div> {# row #}

  </div> {# container #}
</div>
{% endblock %}