{% extends "base.html" %}
{% block content %}
<div class="table-responsive mt-0">
  <table class="table table-sm align-middle table-striped table-stacked table-bordered">
    <thead class="table-light">
      <tr>
        <th class="text-center" style="cursor:pointer;" onclick="sortTableByDate()">
          {{ _('Date') }} <i class="bi bi-arrow-down-up"></i>
        </th>
        <th class="text-center">{{ _('Full') }}</th>
        <th class="text-center">{{ _('Empty') }}</th>
        <th class="text-center">{{ _('Inventory') }}</th>
        <th class="text-center">{{ _('Revenue') }}</th>
        <th class="text-center">{{ _('Expense') }}</th>
        <th class="text-center">{{ _('Cash balance') }}</th>
        <th class="text-center">{{ _('Note') }}</th>
        <th class="text-center">{{ _('Actions') }}</th>
      </tr>
    </thead>
    <tbody>
      {% for e in entries %}
      <!-- Define exactly once per line -->
      {% set changed = (e.full != 0 or e.empty != 0 or e.revenue != 0 or e.expense != 0) %}
      <tr
          data-changed="{{ 1 if changed else 0 }}"
          data-full="{{ 1 if e.full != 0 else 0 }}"
          data-empty="{{ 1 if e.empty != 0 else 0 }}"
          data-revenue="{{ 1 if e.revenue != 0 else 0 }}"
          data-expense="{{ 1 if e.expense != 0 else 0 }}"
      >
        <td class="text-end" data-label="{{ _('Date') }}" data-col="date">{{ format_date_de(e.date) }}</td>

        <!-- Only show ifvalue != 0 -->
        <td class="text-end" data-label="{{ _('Full') }}" data-col="full">{{ e.full ~ ' ' ~ _('Btl.') if e.full != 0 else '' }}</td>
        <td class="text-end" data-label="{{ _('Empty') }}" data-col="empty">{{ e.empty ~ ' ' ~ _('Btl.') if e.empty != 0 else '' }}</td>

        <!-- Inventory: Always show or optionally hide -->
        <td class="text-end" data-label="{{ _('Inventory') }}" data-col="inventory">{{ e.inventory ~ ' ' ~ _('Btl.') if changed else '' }}</td>
        <!-- Revenue/Expense: show only if != 0 -->
        <td class="text-end" data-label="{{ _('Revenue') }}" data-col="revenue">{{ format_eur_de(e.revenue) if e.revenue != 0 else '' }}</td>
        <td class="text-end" data-label="{{ _('Expense') }}" data-col="expense">{{ format_eur_de(e.expense) if e.expense != 0 else '' }}</td>

        <!-- Cash balance: Always show or optionally hide -->
        <td class="text-end" data-label="{{ _('Cash balance') }}" data-col="cashBalance">{{ format_eur_de(e.cashBalance) if changed else '' }}</td>

        <!-- Note: Always display -->
        <td class="text-start" data-label="{{ _('Note') }}" data-col="note">{{ e.note }}</td>
          <td class="text-center" data-label="{{ _('Actions') }}" data-col="actions">
            {% set role = current_user().get('role') %}
            {% if role in ['Editor', 'Manager', 'Admin'] %}
            <a class="btn btn-sm btn-outline-primary"
              href="{{ url_for('bbalance_routes.edit', entry_id=e.id) }}"
              title="{{ _('Edit') }}">
              <i class="bi-pencil-square"></i>
            </a>
            {% endif %}

            <button class="btn btn-sm btn-outline-secondary position-relative"
                    type="button"
                    onclick="openAttachments({{ e.id }})"
                    title="{{ _('Open documents') }}">
              <i class="bi-paperclip"></i>
              {% if e.attachment_count and e.attachment_count > 0 %}
              <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-secondary">
                {{ e.attachment_count }}
              </span>
              {% endif %}
            </button>

            {% if role in ['Editor', 'Manager', 'Admin'] %}
            <form method="post"
                  action="{{ url_for('bbalance_routes.delete', entry_id=e.id) }}"
                  class="d-inline"
                  onsubmit="return confirm('{{ _('Delete entry permanently?') }}');">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button class="btn btn-sm btn-outline-danger" title="{{ _('Delete') }}">
                <i class="bi-trash"></i>
              </button>
            </form>
            {% endif %}
          </td>
        </tr>
        {% else %}
        <tr>
          <td data-label="{{ _('No entries available.') }}" colspan="9" class="text-center text-muted">{{ _('No entries available.') }}</td>
        </tr>
        {% endfor %}
      </tbody>
  </table>
</div>
{% endblock %}