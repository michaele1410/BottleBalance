
<!doctype html>
<html lang="de" data-bs-theme="{{ theme_preference|default('system') }}">
<head>
  <meta charset="utf-8">
  <title>{{ _('BottleBalanceTitle') }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/airbnb.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='custom.css') }}?t={{ now }}">

  <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='images/favicon.svg') }}">
  <link rel="alternate icon" href="{{ url_for('static', filename='images/favicon.ico') }}">

  <meta name="color-scheme" content="light dark">
  <script>
  (() => {
    const stored = localStorage.getItem('theme') || '{{ theme_preference|default("system") }}';
    const systemDark = window.matchMedia('(prefers-color-scheme: dark)');
    const effective = stored === 'system' ? (systemDark.matches ? 'dark' : 'light') : stored;
    document.documentElement.setAttribute('data-bs-theme', effective);
  })();
  </script>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg bg-body-tertiary border-bottom sticky-top">
  <div class="container">
    <a class="navbar-brand fw-semibold d-flex align-items-center gap-2"
      href="{% if current_user().get('role') == 'Payment Viewer' %}
                {{ url_for('payment_routes.zahlungsfreigabe') }}
              {% else %}
                {{ url_for('bbalance_routes.index') }}
              {% endif %}">
      <span class="logo-wrapper">
        <img src="{{ brand_logo_url }}" alt="Logo" class="logo-img">
      </span>
      <span>{{ _('Greeting') }}{% if session.get('user_id') %}, {{ current_user().username|capitalize }}{% endif %}</span>
    </a>

    {% if session.get('user_id') %}
    <!-- Burger Toggle -->
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent"
            aria-controls="navbarContent" aria-expanded="false" aria-label="Menü öffnen">
      <span class="navbar-toggler-icon"></span>
    </button>

    <!-- Collapsible Content -->
    <div class="collapse navbar-collapse" id="navbarContent">
      <div class="ms-auto d-flex flex-column flex-lg-row gap-2 mt-3 mt-lg-0">
        {% if current_user().get('role') != 'Payment Viewer' %}
        <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('bbalance_routes.index') }}">
          <i class="bi-house me-1"></i> {{ _('Dashboard') }}
        </a>
        {% endif %}

        {% if 'payment:view' in (ROLES.get(session.get('role'), [])) %}
        <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('payment_routes.zahlungsfreigabe') }}">
          <i class="bi-tools me-1"></i> {{ _('Anträge') }}
        </a>
        {% endif %}

        {% if 'users:manage' in (ROLES.get(session.get('role'), [])) %}
        <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('user_routes.users_list') }}">
          <i class="bi-people me-1"></i> {{ _('Benutzer') }}
        </a>
        {% endif %}

        {% if 'audit:view' in (ROLES.get(session.get('role'), set())) %}
        <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('audit_list') }}">
          <i class="bi-shield-check me-1"></i> {{ _('Audit') }}
        </a>
        {% endif %}

        <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('profile') }}">
          <i class="bi-person-gear me-1"></i> {{ _('Profil') }}
        </a>        

        {% if 'admin:tools' in (ROLES.get(session.get('role'), [])) %}
        <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('admin_tools') }}">
          <i class="bi-tools me-1"></i> {{ _('Einstellungen') }}
        </a>
        {% endif %}  

        <!-- About -->
        <a class="btn btn-outline-secondary btn-sm" href="#" data-bs-toggle="modal" data-bs-target="#aboutModal">
          <i class="bi-info-circle me-1"></i> {{ _('Über') }}
        </a>

        <form method="post" action="{{ url_for('auth_routes.logout') }}" class="d-inline">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button type="submit" class="btn btn-outline-secondary btn-sm">
            <i class="bi-box-arrow-right me-1"></i> {{ _('Logout') }}
          </button>
        </form>
      </div>
    </div>
    {% endif %}
  </div>
</nav>

<!-- Main -->
<main class="container-fluid my-4 px-2 px-md-3">
  {% block content %}{% endblock %}
</main>

<!-- Footer -->
<footer class="border-top py-3">
  <div class="container text-muted small">
    © <a id="developer-email-footer" class="link-secondary text-decoration-none">Michael Eitdorf</a>
    &nbsp;|&nbsp; Version: <a href="#" data-bs-toggle="modal" data-bs-target="#aboutModal"> {{ app_version }} </a>
    &nbsp;|&nbsp; <a href="https://buymeacoffee.com/michaeleitdorf" target="_blank" rel="noopener noreferrer">
      ☕ Buy me a coffee
    </a>
  </div>
</footer>

<!-- Über-Modal -->
<div class="modal fade" id="aboutModal" tabindex="-1" aria-labelledby="aboutModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="aboutModalLabel">{{ _('Über') }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Schließen"></button>
      </div>
      <div class="modal-body">
        <p><strong>{{ _('Name:') }}</strong> {{ _('BottleBalanceTitle') }}</p>
        <p><strong>{{ _('Version:') }}</strong> {{ app_version }}</p>
        <p><strong>{{ _('Entwickler:') }}</strong> Michael Eitdorf</p>
        <p><strong>{{ _('Kontakt:') }}</strong>
          <a href="mailto:{{ DEVELOPER_EMAIL }}">{{ _('Entwickler kontaktieren') }}</a>
        </p>
        <p><strong>{{ _('Webseite:') }}</strong>
          <a href="{{ developer_url }}" target="_blank" rel="noopener noreferrer">GitHub-Projekt</a>
        </p>
        <hr>
        <p class="small text-muted">
          {{ _('BottleBalanceTitle') }}{{ _(' ist eine Webanwendung zur Verwaltung von Getränkekassen und Zahlungsanträgen.') }}
          <br><br>
            ☕ <a href="https://buymeacoffee.com/michaeleitdorf" target="_blank" rel="noopener noreferrer">
            {{ _('Buy me a coffee') }}
          </a>
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Schließen') }}</button>
      </div>
    </div>
  </div>
</div>

<!-- JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/l10n/de.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>


<script>
  document.addEventListener('DOMContentLoaded', () => {
    const btn = document.getElementById('toTopBtn');
    if (!btn) return;

    // Ab wann der Button eingeblendet wird (in Pixel)
    const SHOW_AFTER_PX = 350;

    // Motion-Preference beachten
    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

    // Performanter Scroll-Handler mit requestAnimationFrame
    let rafId = null;
    const onScroll = () => {
      if (rafId) return;
      rafId = requestAnimationFrame(() => {
        const y = window.scrollY || document.documentElement.scrollTop || 0;
        btn.classList.toggle('d-none', y <= SHOW_AFTER_PX);
        rafId = null;
      });
    };

    // Initial visible state setzen & Listener binden
    onScroll();
    window.addEventListener('scroll', onScroll, { passive: true });

    // Klick → nach oben scrollen (smooth, falls erlaubt)
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      if (prefersReducedMotion) {
        window.scrollTo(0, 0);
      } else {
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }

      // A11y: Fokus am Seitenanfang setzen (H1/H2), ohne Sprung
      const heading = document.getElementById('page-title') || document.querySelector('main h1, main h2');
      if (heading) {
        const restoreTabindex = heading.hasAttribute('tabindex') ? heading.getAttribute('tabindex') : null;
        heading.setAttribute('tabindex', '-1');
        // kurz warten, bis der Scroll abgeschlossen ist
        setTimeout(() => {
          heading.focus({ preventScroll: true });
          // Aufräumen
          if (restoreTabindex === null) {
            heading.removeAttribute('tabindex');
          } else {
            heading.setAttribute('tabindex', restoreTabindex);
          }
        }, prefersReducedMotion ? 0 : 400);
      }
    });

    // Optional: mit Escape ausblendbar (Fokusfreiheit)
    btn.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        btn.classList.add('d-none');
      }
    });
  });
</script>

{% block scripts %}{% endblock %}


<!-- To-Top Button -->
<button
  id="toTopBtn"
  type="button"
  class="btn btn-primary btn-lg to-top-btn d-none"
  aria-label="{{ _('Nach oben') }}"
  title="{{ _('Nach oben') }}"
>
  <i class="bi bi-arrow-up-short" aria-hidden="true"></i>
</button>

</body>
</html>