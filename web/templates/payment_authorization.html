{% extends "base.html" %}
{% block content %}
<div class="card shadow-sm">
  <div class="card-body">
    <h1 class="h5 mb-3">{{ _('Payment request') }}</h1>

    <!-- Actions -->
    <div class="btn-group">
      <div class="d-flex flex-wrap gap-2 mb-3">
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#payment_requestModal">
          <i class="bi-plus-lg me-1"></i> {{ _('New payment request') }}
        </button> 

            <!-- STANDARD: with attachments -->
            <a class="btn btn-outline-danger"
              href="{{ url_for('payment_routes.export_all_payment_requests_pdf', include_attachments=1) }}"
              title="{{ _('PDF export') }}">
              <i class="bi-file-earmark-pdf me-1 text-danger"></i>
              {{ _('All requests as PDF') }}
            </a>

            <!-- SPLIT-DROPDOWN (only 'without attachments') -->
            <button type="button"
                    class="btn btn-outline-danger dropdown-toggle dropdown-toggle-split"
                    data-bs-toggle="dropdown"
                    aria-expanded="false"
                    aria-label="{{ _('Additional export options') }}">
              <span class="visually-hidden">{{ _('Additional export options') }}</span>
            </button>

            <ul class="dropdown-menu dropdown-menu-end">
              <li>
                <a class="dropdown-item"
                  href="{{ url_for('payment_routes.export_all_payment_requests_pdf', include_attachments=0) }}">
                  {{ _('Without attachments') }}
                </a>
              </li>
            </ul>
      </div>
    </div>
    <!-- Table -->
    <div class="table-responsive">
      <table class="table table-bordered align-middle">
        <thead class="table-light">
          <tr>
            <th>{{ _('Requestor') }}</th>
            <th>{{ _('Date') }}</th>
            <th>{{ _('Amount') }}</th>
            <th>{{ _('State') }}</th>
            <th class="text-nowrap">{{ _('Actions') }}</th>
          </tr>
        </thead>

        <tbody>
          {% for a in payment_requests %}
          <tr>
            <td data-label="{{ _('Requestor') }}" colspan="5">
              <div class="mb-2">
                <strong>{{ _('Approval progress') }}:</strong>
                {{ a.approvals_count }} {{ _('from') }} {{ a.approvals_total }} {{ _('approved') }}
                {% if a.approved_by_me %}
                • <i class="bi bi-person-check text-success"></i> {{ _('from you') }}
                {% endif %}
              </div>
              <div class="progress" style="height: 20px;">
                <div class="progress-bar" role="progressbar" style="width: {{ a.approvals_percent }}%;"
                  aria-valuenow="{{ a.approvals_count }}" aria-valuemin="0" aria-valuemax="{{ a.approvals_total }}">
                  {{ a.approvals_count }} / {{ a.approvals_total }}
                </div>
              </div>
            </td>
          </tr>

          <tr>
            <td data-label="{{ _('Requestor') }}">{{ a.requestor }}</td>
            <td data-label="{{ _('Date') }}">{{ a.date }}</td>
            <td data-label="{{ _('Amount') }}">{{ a.amount }} €</td>
            <td data-label="{{ _('State') }}">
              <span class="badge badge-state-{{ a.state|replace(' ', '_') }}">{{ a.state }}</span>
            </td>
            <td data-label="{{ _('Actions') }}" class="text-nowrap">

              <!-- Details -->
              <a href="{{ url_for('payment_routes.payment_request_detail', request_id=a.id) }}"
                class="btn btn-sm btn-outline-secondary">
                {{ _('Details') }}
              </a>

              {% if a.can_approve %}
              <form method="post" action="{{ url_for('payment_routes.approve_payment_request', request_id=a.id) }}"
                style="display:inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button class="btn btn-sm btn-success">{{ _('Approve') }}</button>
              </form>
              {% endif %}

              {% if a.can_withdraw_approval %}
              <form method="post" action="{{ url_for('payment_routes.withdraw_approval', request_id=a.id) }}"
                style="display:inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button class="btn btn-sm btn-warning">{{ _('Withdraw approval') }}</button>
              </form>
              {% endif %}

              {% if a.can_on_hold %}
              <form method="post" action="{{ url_for('payment_routes.on_hold_payment_request', request_id=a.id) }}"
                style="display:inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button class="btn btn-sm btn-outline-warning">{{ _('On hold') }}</button>
              </form>
              {% endif %}

              {% if a.can_continue %}
              <form method="post" action="{{ url_for('payment_routes.continue_payment_request', request_id=a.id) }}"
                style="display:inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button class="btn btn-sm btn-outline-primary">{{ _('Continue') }}</button>
              </form>
              {% endif %}


              {% if a.can_complete %}
              <form method="post" action="{{ url_for('payment_routes.complete_payment_request', request_id=a.id) }}"
                style="display:inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button class="btn btn-sm btn-primary">{{ _('Complete') }}</button>
              </form>
              {% endif %}

              {% if a.can_reject %}
              <!-- Simple inline rejection with reason -->
              <form method="post" action="{{ url_for('payment_routes.reject_payment_request', request_id=a.id) }}"
                style="display:inline" onsubmit="return confirm('{{ _('Reject') }}?');">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="justification" value="Rejected (briefly justified))">
                <!-- replace with modal if necessary -->
                <button class="btn btn-sm btn-outline-danger">{{ _('Reject') }}</button>
              </form>
              {% endif %}

              {% if a.can_withdraw %}
              <form method="post" action="{{ url_for('payment_routes.withdraw_payment_request', request_id=a.id) }}"
                style="display:inline" onsubmit="return confirm('{{ _('Withdraw payment request') }}?');">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button class="btn btn-sm btn-outline-secondary">{{ _('Withdraw') }}</button>
              </form>
              {% endif %}

              {% if a.can_delete and a.state not in ['completed', 'rejected', 'approved'] %}
              <form method="post" action="{{ url_for('payment_routes.delete_payment_request', request_id=a.id) }}"
                style="display:inline" onsubmit="return confirm('{{ _('Delete payment request permanently') }}?');">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button class="btn btn-sm btn-danger">{{ _('Delete') }}</button>
              </form>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
<!-- Modal: Reject -->
<div class="modal fade" id="rejectModal" tabindex="-1" aria-labelledby="rejectModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form method="post" id="rejectForm">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="rejectModalLabel">{{ _('Reject payment request') }}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <div class="mb-3">
            <label class="form-label">{{ _('Justification (mandatory)') }}</label>
            <textarea class="form-control" name="justification" required rows="4"
              placeholder="{{ _('Please specify reason for rejection') }}."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
          <button class="btn btn-danger" type="submit">{{ _('Reject') }}</button>
        </div>
      </div>
    </form>
  </div>
</div>

<script>
  const rejectModal = document.getElementById('rejectModal');
  rejectModal.addEventListener(('show.bs.modal', (event) => {
  const button = event.relatedTarget;
  const payment_requestId = button.getAttribute('data-payment_request-id');
  const form = document.getElementById('rejectForm');
  form.action = "{{ url_for('payment_routes.reject_payment_request', request_id=0) }}".replace('/0', '/' + payment_requestId);
  });
</script>

<!-- Modal: New request -->
<div class="modal fade" id="payment_requestModal" tabindex="-1" aria-labelledby="payment_requestModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form method="post" action="{{ url_for('payment_routes.payment_requests_request') }}" id="payment_requestForm"
      class="needs-validation" novalidate>
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="payment_requestModalLabel">{{ _('Create new payment request') }}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

          <div class="mb-3">
            <div class="input-group mb-3">
              <span class="input-group-text"><i class="bi bi-text-paragraph"></i></span>
              <div class="form-floating flex-grow-1">
                <input type="text" name="paragraph"  inputmode="text" class="form-control"
                  placeholder="{{ _('e.g. 3a') }}" value="§14 Abs. 2">
                  <label for="paragraph">{{ _('Paragraph (optional)') }}</label>
              </div>
            </div>
          </div>

          <div class="input-group mb-3">
            <span class="input-group-text"><i class="bi bi-chat-text"></i></span>
            <div class="form-floating flex-grow-1">
              <input type="text" name="purpose"  inputmode="text" class="form-control"
                placeholder="{{ _('What is the payment request for?') }}?" value="">
                <label for="purpose">{{ _('Purpose') }}</label>
            </div>
          </div>

          <div class="input-group mb-3">
            <span class="input-group-text"><i class="bi bi-calendar"></i></span>
            <div class="form-floating flex-grow-1">
              <input type="date" name="date" class="form-control" required value="{{ today.strftime('%Y-%m-%d') }}">
                <label for="date">{{ _('Date') }}</label>
            </div>
          </div>

          <div class="input-group mb-3">
            <span class="input-group-text"><i class="bi bi-wallet2"></i></span>
            <!-- Amount input -->
            <div class="form-floating flex-grow-1">
              <input type="number" name="amount" inputmode="decimal" class="form-control"
                    placeholder="{{ _('eg. 49,90') }}" value="">
              <label for="amount">{{ _('Amount') }}</label>
              <div class="invalid-feedback">{{ _('Amount') }}.</div>
            </div>
          </div>

          <div class="input-group mb-3">
            <span class="input-group-text"><i class="bi bi-building"></i></span>
            <div class="form-floating flex-grow-1">
              <input type="text" name="supplier"  inputmode="text" class="form-control"
                placeholder="{{ _('Company / Supplier') }}" value="">
                <label for="supplier">{{ _('Supplier (optional)') }}</label>
            </div>
          </div>

          <div class="input-group mb-3">
            <span class="input-group-text"><i class="bi bi-chat-quote"></i></span>
            <div class="form-floating flex-grow-1">
              <input type="text" name="justification" rows="3" inputmode="text" class="form-control"
                placeholder="{{ _('Why is the payment request necessary?') }}?" value="">
                <label for="justification">{{ _('Justification') }}</label>
            </div>
          </div>

          <div class="modal-footer">
            <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
            <button class="btn btn-primary" type="submit">
              <i class="bi bi-check-lg me-1"></i> {{ _('Add') }}
            </button>
          </div>
        </div>
      </div>
    </form>
  </div>
</div>

<script>
  // Enable Bootstrap client validation (optional)
  (() => {
    const form = document.getElementById('payment_requestForm');
    form?.addEventListener('submit', (e) => {
      if (!form.checkValidity()) {
        e.preventDefault();
        e.stopPropagation();
      }
      form.classList.add('was-validated');
    }, false);
  })();

  // Reset form on closing (optional)
  document.getElementById('payment_requestModal')?.addEventListener('hidden.bs.modal', () => {
    const form = document.getElementById('payment_requestForm');
    if (form) {
      form.reset();
      form.classList.remove('was-validated');
    }
  });
</script>

{% endblock %}