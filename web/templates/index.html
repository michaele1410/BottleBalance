
{% extends "base.html" %}
{% block content %}
<div class="row g-3 mb-4">
  <div class="col-12 col-lg-4">
    <div class="p-3 bg-light rounded-3 h-100">
      <div class="mb-1"><strong>Inventory (current):</strong> <span class="fs-5 ms-1">{{ inv_aktuell }}</span> Bottles</div>
      <div><canvas id="sparkInv" height="40"></canvas></div>
      {% if request.args.get('from') or request.args.get('to') %}
      <div class="small text-muted mt-1">In the filter: {{ filter_inv }} Bottles</div>
      {% endif %}
    </div>
  </div>
  <div class="col-12 col-lg-4">
    <div class="p-3 bg-light rounded-3 h-100">
      <div class="mb-1"><strong>Cash on hand (current):</strong> <span class="fs-5 ms-1">{{ format_eur_de(kas_aktuell) }}</span></div>
      <div><canvas id="sparkKas" height="40"></canvas></div>
      {% if request.args.get('from') or request.args.get('to') %}
      <div class="small text-muted mt-1">In the filter: {{ format_eur_de(filter_kas) }}</div>
      {% endif %}
    </div>
  </div>

  {% if can_add %}
  <div class="col-12 col-lg-4">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <h2 class="h6 mb-3">Add new record</h2>
        <form method="post" action="{{ url_for('add') }}" class="row g-2">
          <div class="col-12">
            <label class="form-label">Date</label>
            <input name="datum" id="datum" class="form-control" value="{{ default_date }}" placeholder="dd.MM.yyyy">
          </div>
          <div class="col-6">
            <label class="form-label">Full bottles</label>
            <input name="vollgut" type="number" step="1" class="form-control" placeholder="0">
          </div>
          <div class="col-6">
            <label class="form-label">Empty bottles</label>
            <input name="leergut" type="number" step="1" class="form-control" placeholder="0">
          </div>
          <div class="col-6">
            <label class="form-label">Revenue (€)</label>
            <input name="einnahme" class="form-control" placeholder="z.B. 12,34">
          </div>
          <div class="col-6">
            <label class="form-label">Expenditure (€)</label>
            <input name="ausgabe" class="form-control" placeholder="z.B. -5,00">
          </div>
          <div class="col-12">
            <label class="form-label">Comment</label>
            <input name="bemerkung" class="form-control" maxlength="500" placeholder="Note">
          </div>
          <div class="col-12">
            <button class="btn btn-success w-100"><i class="bi-plus-lg me-1"></i> Add</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  {% endif %}
</div>

<div class="card shadow-sm">
  <div class="card-body">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2 mb-3">
      <h2 class="h5 m-0">Entries</h2>
      <form method="get" class="row g-2 align-items-end w-100 w-md-auto">
        <div class="col-12 col-md-3">
          <label class="form-label">Search</label>
          <input type="text" name="q" class="form-control" placeholder="Date/Comment" value="{{ request.args.get('q','') }}">
        </div>
        <div class="col-6 col-md-2">
          <label class="form-label">From</label>
          <input type="date" name="from" class="form-control" value="{{ request.args.get('from','') }}">
        </div>
        <div class="col-6 col-md-2">
          <label class="form-label">To</label>
          <input type="date" name="to" class="form-control" value="{{ request.args.get('to','') }}">
        </div>
        <div class="col-12 col-md-2 d-grid">
          <button class="btn btn-outline-primary"><i class="bi-search me-1"></i> Filter</button>
        </div>
        <div class="col-12 col-md-2 d-grid">
          <a class="btn btn-outline-secondary" href="{{ url_for('index') }}">Reset</a>
        </div>
      </form>
      <div class="d-flex gap-2 mt-2 mt-md-0">
        {% if can_export_pdf %}
        <a class="btn btn-outline-danger" href="{{ url_for('export_pdf', q=request.args.get('q'), from=request.args.get('from'), to=request.args.get('to')) }}"><i class="bi-file-earmark-pdf me-1"></i> PDF</a>
        {% endif %}
        {% if can_export_csv %}
        <a class="btn btn-outline-primary" href="{{ url_for('export_csv', q=request.args.get('q'), from=request.args.get('from'), to=request.args.get('to')) }}"><i class="bi-download me-1"></i> CSV</a>
        {% endif %}
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-sm align-middle table-striped">
        <thead class="table-light">
          <tr>
            <th>Date</th>
            <th>Full bottle</th>
            <th>Empty bottles</th>
            <th>Inventory</th>
            <th>Revenue</th>
            <th>Expenditure</th>
            <th>Cash on hand</th>
            <th>Comment</th>
            <th class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody>
        {% for e in entries %}
          <tr>
            <td>{{ format_date_de(e.datum) }}</td>
            <td>{{ e.vollgut }}</td>
            <td>{{ e.leergut }}</td>
            <td>{{ e.inventar }}</td>
            <td>{{ format_eur_de(e.einnahme) }}</td>
            <td>{{ format_eur_de(e.ausgabe) }}</td>
            <td>{{ format_eur_de(e.kassenbestand) }}</td>
            <td>{{ e.bemerkung }}</td>
            <td class="text-end">
              <a class="btn btn-sm btn-outline-primary" href="{{ url_for('edit', entry_id=e.id) }}" title="Bearbeiten"><i class="bi-pencil-square"></i></a>
              <form method="post" action="{{ url_for('delete', entry_id=e.id) }}" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this entry?');">
                <button class="btn btn-sm btn-outline-danger" title="Delete"><i class="bi-trash"></i></button>
              </form>
            </td>
          </tr>
        {% else %}
          <tr><td colspan="9" class="text-center text-muted">No entries available.</td></tr>
        {% endfor %}
        </tbody>
      </table>
    </div>

  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
flatpickr('#datum', {dateFormat:'d.m.Y', defaultDate: '{{ default_date }}', locale: 'de'});
const invData = {{ series_inv | tojson }};
const kasData = {{ series_kas | tojson }};
function sparkline(canvasId, data, color){
  const ctx = document.getElementById(canvasId);
  if(!ctx) return;
  new Chart(ctx, { type: 'line', data: { labels: data.map((_,i)=>i+1), datasets: [{ data, borderColor: color, pointRadius: 0, fill: false, tension: 0.3 }] },
    options: { responsive:true, maintainAspectRatio:false, scales:{x:{display:false}, y:{display:false}}, plugins:{legend:{display:false}, tooltip:{enabled:false}}, elements:{line:{borderWidth:2}} }
  });
}
sparkline('sparkInv', invData, '#0d6efd');
sparkline('sparkKas', kasData, '#198754');
</script>
{% endblock %}
