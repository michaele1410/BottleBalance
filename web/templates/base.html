
<!doctype html>
<html lang="de" data-bs-theme="{{ theme_preference|default('system') }}">
<head>
  <meta charset="utf-8">
  <title>{{ _('BottleBalance') }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/airbnb.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='custom.css') }}">
  <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='images/favicon.svg') }}">
  <link rel="alternate icon" href="{{ url_for('static', filename='images/favicon.ico') }}">

  <meta name="color-scheme" content="light dark">
  <script>
  (() => {
    const stored = localStorage.getItem('theme') || '{{ theme_preference|default("system") }}';
    const systemDark = window.matchMedia('(prefers-color-scheme: dark)');
    const effective = stored === 'system' ? (systemDark.matches ? 'dark' : 'light') : stored;
    document.documentElement.setAttribute('data-bs-theme', effective);
  })();
  </script>
</head>
<body>
<nav class="navbar navbar-expand-lg bg-body-tertiary border-bottom">
  <div class="container">
    <a class="navbar-brand fw-semibold d-flex align-items-center gap-2" href="{{ url_for('index') }}">
      <span class="logo-wrapper">
        <img src="{{ url_for('static', filename='images/logo.svg') }}" alt="Logo" class="logo-img">
      </span>
      <span>{{ _('BottleBalance') }}{% if session.get('user_id') %}, {{ current_user().username|capitalize }}{% endif %}</span>
    </a>
    {% if session.get('user_id') %}
    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('index') }}"><i class="bi-house me-1"></i>  {{ _('Dashboard') }}</a>
      {% if 'users:manage' in (ROLES.get(session.get('role'), [])) %}
      <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('users_list') }}"><i class="bi-people me-1"></i> {{ _('Benutzer') }}</a>
      {% endif %}
      {% if 'audit:view' in (ROLES.get(session.get('role'), set())) %}
      <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('audit_list') }}"><i class="bi-shield-check me-1"></i> {{ _('Audit') }}</a>
      {% endif %}
      <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('profile') }}"><i class="bi-person-gear me-1"></i> {{ _('Profil') }}</a>
      <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('logout') }}"><i class="bi-box-arrow-right me-1"></i> {{ _('Logout') }}</a>
    </div>
    {% endif %}
  </div>
</nav>

<main class="container my-4">
  {% with messages = get_flashed_messages() %}
    {% if messages %}
      <div class="alert alert-warning">{% for m in messages %}<div>{{ m }}</div>{% endfor %}</div>
    {% endif %}
  {% endwith %}
  {% block content %}{% endblock %}
</main>

<footer class="border-top py-3">
  <div class="container text-muted small">
    Â© <a href="mailto:webmaster@michaeleitdorf.de" class="link-secondary text-decoration-none">Michael Eitdorf</a>
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/l10n/de.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const mq = window.matchMedia('(prefers-color-scheme: dark)');
  function applyTheme(mode) {
    const effective = mode === 'system' ? (mq.matches ? 'dark' : 'light') : mode;
    localStorage.setItem('theme', mode);
    document.documentElement.setAttribute('data-bs-theme', effective);
  }
  document.querySelectorAll('input[name="theme"]').forEach(radio => {
    radio.addEventListener('change', e => applyTheme(e.target.value));
  });
  mq.addEventListener('change', () => {
    if ((localStorage.getItem('theme') || '{{ theme_preference|default("system") }}') === 'system') {
      applyTheme('system');
    }
  });
});
</script>

{% endblock %}
</body>
</html>
