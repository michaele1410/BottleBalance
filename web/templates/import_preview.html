
{% extends "base.html" %}
{% block content %}

<div class="card shadow-sm mb-3">
  <div class="card-body">
    <!-- Title + Back button -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h1 class="h5 mb-0">{{ _('CSV import – Preview') }}</h1>
      <a href="{{ url_for('bbalance_routes.index') }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left me-1"></i> {{ _('Back') }}
      </a>
    </div>

    <!-- Summary -->
    <div class="mb-2 text-muted">
      <span class="me-3">{{ _('Total:') }} <strong>{{ total }}</strong></span>
      <span class="me-3">{{ _('potential duplicates:') }} <strong>{{ dup_count }}</strong></span>
      {% if replace_all %}
        <span class="fw-semibold text-danger">{{ _('Mode: All existing entries will be replaced') }}</span>
      {% else %}
        <span>{{ _('Mode: Append (existing entries are retained)') }}</span>
      {% endif %}
    </div>

    <!-- Legend -->
    <div class="d-flex flex-wrap gap-2 mb-3">
      <span class="badge bg-warning-subtle text-warning-emphasis border">{{ _('Duplicate') }}</span>
      <span class="badge bg-danger-subtle text-danger-emphasis border">{{ _('Error in line') }}</span>
    </div>

    <!-- Mapping area -->
    {% if allow_mapping %}
    <div class="card mb-3">
      <div class="card-header">
        <strong>{{ _('Field mapping') }}</strong>
      </div>
      <div class="card-body">
        <form method="post" action="{{ url_for('import_preview') }}">
          <input type="hidden" name="token" value="{{ token }}">
          <input type="hidden" name="remap" value="1">
          <input type="hidden" name="replace_all" value="{{ 'on' if replace_all else '' }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

          {% set fields = [
            {'key': 'Date',   'label': _('Date')},
            {'key': 'Full',   'label': _('Full')},
            {'key': 'Empty',  'label': _('Empty')},
            {'key': 'Revenue', 'label': _('Revenue')},
            {'key': 'Expense', 'label': _('Expense')},
            {'key': 'Note',    'label': _('Note')}
          ] %}

          <div class="row g-3">
            {% for f in fields %}
              {% set field_id = f.key|lower|replace(' ', '_') %}
              <div class="col-12 col-md-4">
                <div class="form-floating">
                  <select class="form-select" name="map_{{ field_id }}" id="map_{{ field_id }}">
                    <option value="__none__">– {{ _('none') }} –</option>
                    {% for h in headers %}
                      <option value="{{ loop.index0 }}"
                        {% if mapping and (mapping.get(f.key) is not none) and mapping.get(f.key) == loop.index0 %}selected{% endif %}>
                        {{ h }}
                      </option>
                    {% endfor %}
                  </select>
                  <label for="map_{{ field_id }}"><strong>{{ f.label }}</strong></label>
                </div>
              </div>
            {% endfor %}
          </div>

          <div class="text-end mt-3">
            <button type="submit" class="btn btn-primary">
              <i class="bi bi-arrow-repeat me-1"></i> {{ _('Apply mapping & refresh preview') }}
            </button>
          </div>
        </form>
      </div>
    </div>
    {% endif %}

    <!-- Preview table -->
    <div class="card mb-3">
      <div class="card-header">
        <strong>{{ _('Preview') }}</strong>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive border-top">
          <table class="table table-sm mb-0 align-middle">
            <thead class="table-light">
              <tr>
                <th>#</th>
                <th>{{ _('Date') }}</th>
                <th class="text-end">{{ _('Full') }}</th>
                <th class="text-end">{{ _('Empty') }}</th>
                <th class="text-end">{{ _('Revenue') }}</th>
                <th class="text-end">{{ _('Expense') }}</th>
                <th>{{ _('Note') }}</th>
                <th>{{ _('State') }}</th>
              </tr>
            </thead>
            <tbody>
              {% for r in preview_rows %}
                {% set row_class = 'table-danger' if r.errors|length > 0 else ('table-warning' if r.is_duplicate and not replace_all else '') %}
                <tr class="{{ row_class }}">
                  <td>{{ r.line_no }}</td>
                  <td>{{ r.date and format_date_de(r.date) or '–' }}</td>
                  <td class="text-end">{{ r.full }}</td>
                  <td class="text-end">{{ r.empty }}</td>
                  <td class="text-end">{{ r.revenue }}</td>
                  <td class="text-end">{{ r.expense }}</td>
                  <td>{{ r.note }}</td>
                  <td>
                    {% if r.errors|length > 0 %}
                      <div class="fw-semibold">{{ _('Error:') }}</div>
                      <ul class="mb-0 ps-3">
                        {% for e in r.errors %}<li>{{ e }}</li>{% endfor %}
                      </ul>
                    {% else %}
                      {% if replace_all %}
                        {{ _('is being imported') }}
                      {% else %}
                        {% if r.is_duplicate %}
                          {{ _('Duplicate – skipped (default)') }}
                        {% else %}
                          {{ _('new – being imported') }}
                        {% endif %}
                      {% endif %}
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Commit-Formular -->
    <form action="{{ url_for('import_commit') }}" method="post" class="d-flex flex-wrap gap-3 align-items-center">
      <input type="hidden" name="token" value="{{ token }}">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

      {% if not replace_all %}
        <div class="d-flex flex-column">
          <label class="d-flex align-items-center gap-2">
            <input type="radio" name="mode" value="skip_dups" checked>
            <span>{{ _('Skip duplicates (recommended)') }}</span>
          </label>
          <label class="d-flex align-items-center gap-2">
            <input type="radio" name="mode" value="insert_all">
            <span>{{ _('Insert all (including duplicates)') }}</span>
          </label>
        </div>
      {% else %}
        <input type="hidden" name="mode" value="insert_all">
      {% endif %}

      <label class="d-flex align-items-center gap-2 mb-0">
        <input type="checkbox" name="import_invalid">
        <span>{{ _('Import lines with errors (not recommended)') }}</span>
      </label>

      <div class="ms-auto d-flex flex-wrap gap-2">
        <button type="submit" class="btn btn-success">
          <i class="bi bi-check-lg me-1"></i> {{ _('Import now') }}
        </button>
        <a href="{{ url_for('bbalance_routes.index') }}" class="btn btn-outline-secondary">
          {{ _('Cancel') }}
        </a>
      </div>
    </form>
  </div>
</div>

{% endblock %}
