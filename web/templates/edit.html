{% extends "base.html" %}
{% block content %}
<div class="row justify-content-center">
  <div class="col-12">
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h1 class="h5 mb-0">{{ _('Edit record') }}</h1>
          <div class="d-flex gap-2">
            <a href="{{ url_for('bbalance_routes.index') }}" class="btn btn-outline-secondary">
              {{ _('Back') }}
            </a>
          </div>
        </div>
        <form method="post" action="{{ url_for('bbalance_routes.edit_post', entry_id=data.id) }}" class="row g-3"
          id="transaction-form" novalidate>
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

          <!-- Date -->
          <div class="input-group mb-3">
            <span class="input-group-text"><i class="bi bi-calendar"></i></span>
            <div class="form-floating flex-grow-1">
              <input type="text" name="date"  inputmode="decimal" class="form-control"
                placeholder="Date" id="date" value="{{ data.date.strftime('%d.%m.%Y') if data.date else '' }}" required autofocus>
                <label for="date">{{ _('Date') }}</label>
            </div>
          </div>

          <!-- Full bottles -->
          <div class="input-group mb-3">
            <span class="input-group-text"><i class="bi bi-cup-straw"></i></span>
            <div class="form-floating flex-grow-1">
              <input name="full" type="number" inputmode="numeric" min="0" step="1" class="form-control"
                placeholder="0" id="full" autocomplete="off" value="{{ data.full if data.full is not none else '' }}">
              <label for="full">{{ _('Full bottles') }}</label>
            </div>
          </div>

          <!-- Empty bottles -->
          <div class="input-group mb-3">
            <span class="input-group-text"><i class="bi bi-cup-straw"></i></span>
            <div class="form-floating flex-grow-1">
              <input name="empty" type="number" inputmode="numeric" min="0" step="1" class="form-control"
                placeholder="0" id="empty" autocomplete="off" value="{{ data.empty if data.empty is not none else '' }}">
              <label for="empty">{{ _('Empty Bottles') }}</label>
            </div>
          </div>

          <!-- Revenue -->
          <div class="input-group mb-3">
            <span class="input-group-text"><i class="bi bi-plus-circle"></i></span>
            <div class="form-floating flex-grow-1">
              <input name="revenue" id="revenue" type="number" step="0.01" inputmode="decimal" class="form-control"
                placeholder="0.00" autocomplete="off"
                value="{{ (data.revenue|replace(',', '.') if data.revenue is string else ('%.2f'|format(data.revenue))) if data.revenue is not none else '' }}">
              <label for="revenue">{{ _('Revenue') }}</label>
            </div>
          </div>

          <!-- Expense -->
          <div class="input-group mb-3">
            <span class="input-group-text"><i class="bi bi-dash-circle"></i></span>
            <div class="form-floating flex-grow-1">
              <input name="expense" id="expense" type="number" step="0.01" inputmode="decimal" class="form-control"
                placeholder="0.00" autocomplete="off"
                value="{{ (data.expense|replace(',', '.') if data.expense is string else ('%.2f'|format(data.expense))) if data.expense is not none else '' }}">
              <label for="expense">{{ _('Expense') }}</label>
            </div>
          </div>

          <!-- Note as a dropdown -->
           <div class="input-group mb-3">
            <span class="input-group-text"><i class="bi bi-chat-text"></i></span>
            <div class="form-floating flex-grow-1">
              <select id="note" name="note" class="form-select">
                {% set found = false %}
                {% for option in notes %}
                  {% if data.note == option %}
                    {% set found = true %}
                  {% endif %}
                  <option value="{{ option }}" {% if data.note == option %}selected{% endif %}>{{ option }}</option>
                {% endfor %}
                {% if data.note and not found %}
                  <option value="{{ data.note }}" selected>{{ data.note }}</option>
                {% endif %}
              </select>
              <label for="note">{{ _('Note') }}</label>
            </div>
          </div>

          <div class="col-12 d-flex gap-2">
            <a class="btn btn-outline-secondary" href="{{ url_for('bbalance_routes.index') }}">{{ _('Cancel') }}</a>
            <button class="btn btn-primary">{{ _('Save') }}</button>
          </div>
        </form>

        <hr class="my-4">
        <h3 class="h6 mb-3">{{ _('Attachments') }}</h3>

        <form action="{{ url_for('attachments_routes.attachments_upload', entry_id=data.id) }}" method="post"
          enctype="multipart/form-data" class="mb-3">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <div class="input-group">
            <input class="form-control" type="file" name="files" multiple
              accept=".pdf,.png,.jpg,.jpeg,.gif,.webp,.heic,.heif,.svg,.txt,.csv,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.xml,.json">
            <button class="btn btn-outline-primary" type="submit">
              <i class="bi-upload me-1"></i> {{ _('Upload') }}
            </button>
          </div>
          <div class="form-text">
            {{ _('Acceptable formats:') }} PDF, images, Office, text. {{ _('Multiple files possible.') }}
          </div>
        </form>

        <div class="list-group mb-3" id="editAttachmentsList">
          {% if attachments %}
          {% for att in attachments %}
          <div class="list-group-item d-flex justify-content-between align-items-center">
            <div class="text-truncate" style="max-width: 70%;">
              <i class="bi bi-paperclip me-1"></i>
              <a href="{{ att.url }}" target="_blank">{{ att.name }}</a>
              <small class="text-muted">({{ att.size }} Bytes)</small>
              <a href="{{ att.view_url }}" target="_blank" class="btn btn-sm btn-outline-primary">{{ _('Ansehen') }}</a>
            </div>
            <form method="post" action="{{ url_for('attachments_routes.attachments_delete', att_id=att.id) }}"
              onsubmit="return confirm('{{ _('Delete attachment for real?') }}');">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button class="btn btn-sm btn-outline-danger">{{ _('Delete') }}</button>
            </form>
          </div>
          {% endfor %}
          {% else %}
          <div class="list-group-item text-muted">{{ _('No attachments available.') }}</div>
          {% endif %}
        </div>
        <h5 class="mt-5">Audit history</h5>
        <table class="table table-sm table-striped align-middle">
          <thead class="table-light">
            <tr>
              <th>{{ _('Time') }}</th>
              <th>{{ _('Action') }}</th>
              <th>{{ _('User') }}</th>
              <th>{{ _('Details') }}</th>
            </tr>
          </thead>
          <tbody>
            {% for a in audit %}
            <tr>
              <td data-label="{{ _('Time') }}">{{ a.created_at|localize_dt_str }}</td>
              <td data-label="{{ _('Action') }}">{{ a.action }}</td>
              <td data-label="{{ _('User') }}">{{ a.username or 'Unknown' }}</td>
              <td data-label="{{ _('Details') }}">{{ (a.detail or '')|replace('\n', '<br>')|safe }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', () => {
    function isDark() {
      return document.documentElement.getAttribute('data-bs-theme') === 'dark';
    }
    function toggleCalendarDark(calEl, dark) {
      if (!calEl) return;
      calEl.classList.toggle('flatpickr-dark', !!dark);
    }
    if (window.flatpickr) {
      if (flatpickr.l10ns?.de) flatpickr.localize(flatpickr.l10ns.de);
      const fp = flatpickr('#date', {
        allowInput: true,
        dateFormat: 'd.m.Y',
        clickOpens: true,
        disableMobile: false,
        onOpen: (selectedDates, dateStr, instance) => {
          toggleCalendarDark(instance.calendarContainer, isDark());
        }
      });
      const themeObserver = new MutationObserver(() => {
        const dark = isDark();
        document.querySelectorAll('.flatpickr-calendar').forEach(c => toggleCalendarDark(c, dark));
      });
      themeObserver.observe(document.documentElement, { attributes: true, attributeFilter: ['data-bs-theme'] });
    }

    const form = document.getElementById('transaction-form');
    if (form) {
      form.addEventListener('submit', (event) => {
        if (!form.checkValidity()) {
          event.preventDefault();
          event.stopPropagation();
        }
        form.classList.add('was-validated');
      }, false);
    }
  });
</script>

<script>
  document.addEventListener('DOMContentLoaded', async () => {
    const entryId = {{ data.id }};
    const listGroup = document.getElementById('editAttachmentsList');
    try {
      const resp = await fetch(`/attachments/${entryId}/list`);
      const attachments = await resp.json();

      listGroup.innerHTML = '';

      if (!attachments || attachments.length === 0) {
        listGroup.innerHTML = `<div class="list-group-item text-muted">{{ _('No attachments available.') }}</div>`;
        return;
      }

      attachments.forEach(att => {
        const item = document.createElement('div');
        item.className = 'list-group-item d-flex justify-content-between align-items-center';

        const deleteUrl = `/attachments/${att.id}/delete`;

        item.innerHTML = `
          <div class="text-truncate" style="max-width: 70%;">
            <i class="bi bi-paperclip me-1"></i>
            <a href="${att.url}" target="_blank">${att.name}</a>
            <small class="text-muted">(${att.size} Bytes)</small>
            <a href="${att.view_url}" target="_blank" class="btn btn-sm btn-outline-primary">{{ _('Wiew') }}</a>
          </div>
          <form method="post" action="${deleteUrl}" onsubmit="return confirm('{{ _('Delete attachment for permanently?') }}');">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button class="btn btn-sm btn-outline-danger">{{ _('Delete') }}</button>
          </form>
        `;

        listGroup.appendChild(item);
      });
    } catch (e) {
      console.error('{{ _("Error loading attachments:") }}', e);
      listGroup.innerHTML = `<div class="list-group-item text-danger">{{ _('Error loading attachments.') }}</div>`;
    }
  });
</script>
{% endblock %}